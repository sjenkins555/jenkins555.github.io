<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketMentor - Stock Market Simulation</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #131824;
            --bg-tertiary: #1a1f2e;
            --bg-card: #1e2433;
            --accent-green: #00ff88;
            --accent-red: #ff3366;
            --accent-blue: #00aaff;
            --accent-yellow: #ffd700;
            --text-primary: #e8edf4;
            --text-secondary: #98a2b3;
            --text-muted: #6b7785;
            --border: #2a3142;
            --border-highlight: #3a4556;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0d1220 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background grid */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.15;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        #root {
            position: relative;
            z-index: 1;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            background: rgba(19, 24, 36, 0.95);
            border-bottom: 2px solid var(--border-highlight);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: 'â—†';
            font-size: 1.2rem;
            -webkit-text-fill-color: var(--accent-green);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .balance-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-green);
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'IBM Plex Sans', sans-serif;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), #00cc70);
            color: var(--bg-primary);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-highlight);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent-blue);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #cc1144);
            color: white;
        }

        /* Login/Signup Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .auth-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            border-radius: 16px;
            padding: 3rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }

        .form-toggle {
            text-align: center;
            margin-top: 2rem;
            color: var(--text-muted);
        }

        .form-toggle button {
            background: none;
            border: none;
            color: var(--accent-green);
            cursor: pointer;
            font-weight: 600;
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 2rem 0;
        }

        .nav-item {
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-green);
            border-right: 3px solid var(--accent-green);
        }

        .nav-icon {
            font-size: 1.3rem;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Portfolio Grid */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-green);
            box-shadow: 0 8px 24px rgba(0, 255, 136, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-change {
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            color: var(--accent-green);
        }

        .stat-change.negative {
            color: var(--accent-red);
        }

        /* Tables */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .stock-symbol {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--accent-blue);
        }

        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-input {
            flex: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }

        /* Transaction Form */
        .transaction-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-blue);
        }

        .quantity-input {
            flex: 1;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .transaction-summary {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-top: 0.5rem;
        }

        /* Teacher Dashboard */
        .teacher-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-highlight);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-green);
            box-shadow: 0 8px 24px rgba(0, 255, 136, 0.2);
        }

        .control-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .control-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .control-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .header {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .portfolio-grid {
                grid-template-columns: 1fr;
            }

            .market-movers-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-green);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: var(--accent-green);
        }

        .alert-error {
            background: rgba(255, 51, 102, 0.1);
            border: 1px solid rgba(255, 51, 102, 0.3);
            color: var(--accent-red);
        }

        .alert-info {
            background: rgba(0, 170, 255, 0.1);
            border: 1px solid rgba(0, 170, 255, 0.3);
            color: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // ============ DATA STORAGE (In production, use backend API) ============
        const STORAGE_KEY = 'marketmentor_data';

        const loadData = () => {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const data = JSON.parse(stored);
                
                // Migration: Add default research links to existing classes that don't have them
                if (data.teacherCodes) {
                    data.teacherCodes = data.teacherCodes.map(code => {
                        if (!code.researchLinks) {
                            return {
                                ...code,
                                researchLinks: [
                                    { name: 'Yahoo Finance', url: 'https://finance.yahoo.com', description: 'Stock quotes, news, and financial data' },
                                    { name: 'Investopedia', url: 'https://www.investopedia.com', description: 'Financial education and definitions' },
                                    { name: 'MarketWatch', url: 'https://www.marketwatch.com', description: 'Market news and stock analysis' },
                                    { name: 'SEC Filings (EDGAR)', url: 'https://www.sec.gov/edgar/searchedgar/companysearch.html', description: 'Official company filings and reports' }
                                ]
                            };
                        }
                        return code;
                    });
                }
                
                return data;
            }
            return {
                users: [],
                teachers: [],
                classes: [],
                transactions: [],
                teacherCodes: []
            };
        };

        const saveData = (data) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        };

        // ============ FINNHUB.IO STOCK API ============
        // Sign up for free at: https://finnhub.io/register
        const FINNHUB_API_KEY = 'd52r2dhr01qggm5tgr60d52r2dhr01qggm5tgr6g';  // Replace with your actual key!
        
        const DEFAULT_SYMBOLS = [
            'AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX',
            'JPM', 'BAC', 'V', 'MA', 'WMT', 'HD', 'DIS', 'NKE', 'AMD', 'INTC',
            'PYPL', 'UBER', 'ABNB', 'COIN', 'SQ', 'SHOP'
        ];

        // Fetch real stock price from Finnhub
        const fetchStockPrice = async (symbol) => {
            try {
                // Check if API key is set
                if (FINNHUB_API_KEY === 'd52r2dhr01qggm5tgr60d52r2dhr01qggm5tgr6g') {
                    console.warn('Finnhub API key not set! Using mock data.');
                    return {
                        symbol: symbol,
                        name: symbol,
                        price: 100 + Math.random() * 50,
                        change: (Math.random() - 0.5) * 10,
                        changePercent: (Math.random() - 0.5) * 5,
                        volume: 0,
                        error: false
                    };
                }

                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error || data.c === 0) {
                    throw new Error('Invalid stock or API limit reached');
                }
                
                const currentPrice = data.c;
                const change = data.d;
                const changePercent = data.dp;
                
                // Get company name
                const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${FINNHUB_API_KEY}`;
                const profileResponse = await fetch(profileUrl);
                const profileData = await profileResponse.json();
                
                return {
                    symbol: symbol,
                    name: profileData.name || symbol,
                    price: parseFloat(currentPrice.toFixed(2)),
                    change: parseFloat(change.toFixed(2)),
                    changePercent: parseFloat(changePercent.toFixed(2)),
                    volume: 0
                };
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return {
                    symbol: symbol,
                    name: symbol,
                    price: 100,
                    change: 0,
                    changePercent: 0,
                    error: true
                };
            }
        };

        // Fetch historical stock price from Finnhub
        const fetchHistoricalPrice = async (symbol, yearsAgo) => {
            try {
                // Check if API key is set
                if (FINNHUB_API_KEY === 'd52r2dhr01qggm5tgr60d52r2dhr01qggm5tgr6g') {
                    // Mock historical data - simulate growth
                    const mockGrowthRate = 0.08; // 8% annual growth
                    const currentMockPrice = 100 + Math.random() * 50;
                    const historicalMockPrice = currentMockPrice / Math.pow(1 + mockGrowthRate, yearsAgo);
                    return {
                        price: historicalMockPrice,
                        date: new Date(Date.now() - yearsAgo * 365.25 * 24 * 60 * 60 * 1000),
                        available: true,
                        mock: true
                    };
                }

                const now = Math.floor(Date.now() / 1000);
                const secondsPerYear = 365.25 * 24 * 60 * 60;
                const then = now - (yearsAgo * secondsPerYear);
                
                // Get daily candles (OHLC data)
                const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${then}&to=${then + (7 * 24 * 60 * 60)}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.s === 'ok' && data.c && data.c.length > 0) {
                    // Return the closing price from the first available day
                    return {
                        price: data.c[0],
                        date: new Date(data.t[0] * 1000),
                        available: true
                    };
                } else {
                    // Stock wasn't trading that far back
                    return { available: false };
                }
            } catch (error) {
                console.error(`Error fetching historical price for ${symbol}:`, error);
                return { available: false };
            }
        };

        // Calculate portfolio historical returns
        const calculateHistoricalReturns = async (portfolio, currentStocks, yearsAgo) => {
            let totalInvestedThen = 0;
            let totalValueNow = 0;
            let stocksWithData = 0;
            
            for (const holding of portfolio) {
                const currentStock = currentStocks.find(s => s.symbol === holding.symbol);
                if (!currentStock) continue;
                
                const historicalData = await fetchHistoricalPrice(holding.symbol, yearsAgo);
                
                if (historicalData.available) {
                    const investmentAmount = holding.shares * holding.avgCost;
                    const sharesThen = investmentAmount / historicalData.price;
                    const valueNow = sharesThen * currentStock.price;
                    
                    totalInvestedThen += investmentAmount;
                    totalValueNow += valueNow;
                    stocksWithData++;
                }
                
                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (stocksWithData === 0) {
                return null;
            }
            
            const totalReturn = totalValueNow - totalInvestedThen;
            const returnPercent = (totalReturn / totalInvestedThen) * 100;
            const annualizedReturn = Math.pow(totalValueNow / totalInvestedThen, 1 / yearsAgo) - 1;
            
            return {
                invested: totalInvestedThen,
                currentValue: totalValueNow,
                totalReturn: totalReturn,
                returnPercent: returnPercent,
                annualizedReturn: annualizedReturn * 100,
                stocksAnalyzed: stocksWithData,
                yearsAgo: yearsAgo
            };
        };

        // Search stocks on Finnhub
        const searchStocks = async (query) => {
            if (!query || query.length < 1) {
                // Load default stocks
                const stocks = [];
                for (const symbol of DEFAULT_SYMBOLS) {
                    const stock = await fetchStockPrice(symbol);
                    stocks.push(stock);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                return stocks;
            }
            
            // First, try direct symbol lookup (most reliable)
            const cleanQuery = query.trim().toUpperCase();
            try {
                const directStock = await fetchStockPrice(cleanQuery);
                if (!directStock.error) {
                    return [directStock];
                }
            } catch (error) {
                console.log('Direct lookup failed, trying search...');
            }
            
            // If direct lookup fails, try search endpoint
            try {
                const url = `https://finnhub.io/api/v1/search?q=${query}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.result || data.result.length === 0) {
                    return [];
                }
                
                const symbols = data.result
                    .filter(r => r.type === 'Common Stock')
                    .map(r => r.symbol)
                    .slice(0, 10);
                
                const stocks = [];
                for (const symbol of symbols) {
                    const stock = await fetchStockPrice(symbol);
                    if (!stock.error) {
                        stocks.push(stock);
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                return stocks;
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        };
        const searchStocks = async (query) => {
            if (!query || query.length < 1) {
                // Load default stocks
                const stocks = [];
                for (const symbol of DEFAULT_SYMBOLS) {
                    const stock = await fetchStockPrice(symbol);
                    stocks.push(stock);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                return stocks;
            }
            
            // First, try direct symbol lookup (most reliable)
            const cleanQuery = query.trim().toUpperCase();
            try {
                const directStock = await fetchStockPrice(cleanQuery);
                if (!directStock.error) {
                    return [directStock];
                }
            } catch (error) {
                console.log('Direct lookup failed, trying search...');
            }
            
            // If direct lookup fails, try search endpoint
            try {
                const url = `https://finnhub.io/api/v1/search?q=${query}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.result || data.result.length === 0) {
                    return [];
                }
                
                const symbols = data.result
                    .filter(r => r.type === 'Common Stock')
                    .map(r => r.symbol)
                    .slice(0, 10);
                
                const stocks = [];
                for (const symbol of symbols) {
                    const stock = await fetchStockPrice(symbol);
                    if (!stock.error) {
                        stocks.push(stock);
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                return stocks;
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        };



        // ============ MAIN APP COMPONENT ============
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isTeacher, setIsTeacher] = useState(false);
            const [view, setView] = useState('login');
            const [data, setData] = useState(() => {
                const loaded = loadData();
                // Save immediately after migration
                saveData(loaded);
                return loaded;
            });

            useEffect(() => {
                saveData(data);
            }, [data]);

            const login = (username, password, asTeacher = false) => {
                const users = asTeacher ? data.teachers : data.users;
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    setCurrentUser(user);
                    setIsTeacher(asTeacher);
                    setView(asTeacher ? 'teacher-dashboard' : 'dashboard');
                    return true;
                }
                return false;
            };

            const logout = () => {
                setCurrentUser(null);
                setIsTeacher(false);
                setView('login');
            };

            const signup = (userData) => {
                if (userData.isTeacher) {
                    const newTeacher = {
                        id: Date.now(),
                        ...userData,
                        balance: 100000, // Teachers also start with balance to demonstrate
                        portfolio: [],
                        transactions: [],
                        createdAt: new Date().toISOString()
                    };
                    setData({...data, teachers: [...data.teachers, newTeacher]});
                } else {
                    const newUser = {
                        id: Date.now(),
                        ...userData,
                        balance: 100000, // Starting balance
                        portfolio: [],
                        transactions: [],
                        createdAt: new Date().toISOString()
                    };
                    setData({...data, users: [...data.users, newUser]});
                }
                return true;
            };

            const updateUser = (updatedUser) => {
                if (isTeacher) {
                    const teachers = data.teachers.map(t => 
                        t.id === updatedUser.id ? updatedUser : t
                    );
                    setData({...data, teachers});
                } else {
                    const users = data.users.map(u => 
                        u.id === updatedUser.id ? updatedUser : u
                    );
                    setData({...data, users});
                }
                setCurrentUser(updatedUser);
            };

            if (view === 'login' || view === 'signup') {
                return <AuthScreen 
                    view={view} 
                    setView={setView} 
                    login={login}
                    signup={signup}
                    data={data}
                />;
            }

            if (isTeacher) {
                return <TeacherDashboard 
                    teacher={currentUser}
                    logout={logout}
                    data={data}
                    setData={setData}
                />;
            }

            return <StudentDashboard 
                user={currentUser}
                updateUser={updateUser}
                logout={logout}
            />;
        };

        // ============ AUTH SCREEN ============
        const AuthScreen = ({ view, setView, login, signup, data }) => {
            const [formData, setFormData] = useState({
                username: '',
                password: '',
                name: '',
                teacherCode: '',
                isTeacher: false
            });
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                if (view === 'login') {
                    const success = login(formData.username, formData.password, formData.isTeacher);
                    if (!success) {
                        setError('Invalid credentials');
                    }
                } else {
                    if (!formData.isTeacher && !formData.teacherCode) {
                        setError('Teacher code is required for students');
                        return;
                    }
                    if (!formData.isTeacher) {
                        const validCode = data.teacherCodes.find(c => c.code === formData.teacherCode);
                        if (!validCode) {
                            setError('Invalid teacher code');
                            return;
                        }
                    }
                    signup(formData);
                    setView('login');
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card fade-in">
                        <h1 className="auth-title">
                            {view === 'login' ? 'Welcome Back' : 'Create Account'}
                        </h1>
                        <p className="auth-subtitle">
                            {view === 'login' 
                                ? 'Enter your username and password' 
                                : 'Pick a username - no email required!'}
                        </p>

                        {error && <div className="alert alert-error">{error}</div>}

                        <form onSubmit={handleSubmit}>
                            {view === 'signup' && (
                                <div className="form-group">
                                    <label className="form-label">Full Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                    />
                                </div>
                            )}

                            <div className="form-group">
                                <label className="form-label">Username</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.username}
                                    onChange={(e) => setFormData({...formData, username: e.target.value})}
                                    required
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                    required
                                />
                            </div>

                            {view === 'signup' && (
                                <>
                                    <div className="form-group">
                                        <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                            <input
                                                type="checkbox"
                                                checked={formData.isTeacher}
                                                onChange={(e) => setFormData({...formData, isTeacher: e.target.checked})}
                                            />
                                            <span className="form-label" style={{margin: 0}}>I'm a teacher</span>
                                        </label>
                                    </div>

                                    {!formData.isTeacher && (
                                        <div className="form-group">
                                            <label className="form-label">Teacher Code</label>
                                            <input
                                                type="text"
                                                className="form-input"
                                                value={formData.teacherCode}
                                                onChange={(e) => setFormData({...formData, teacherCode: e.target.value})}
                                                placeholder="Enter code from your teacher"
                                                required
                                            />
                                        </div>
                                    )}
                                </>
                            )}

                            {view === 'login' && (
                                <div className="form-group">
                                    <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                        <input
                                            type="checkbox"
                                            checked={formData.isTeacher}
                                            onChange={(e) => setFormData({...formData, isTeacher: e.target.checked})}
                                        />
                                        <span className="form-label" style={{margin: 0}}>Login as teacher</span>
                                    </label>
                                </div>
                            )}

                            <button type="submit" className="btn btn-primary" style={{width: '100%', marginTop: '1rem'}}>
                                {view === 'login' ? 'Sign In' : 'Create Account'}
                            </button>
                        </form>

                        <div className="form-toggle">
                            {view === 'login' ? (
                                <>Don't have an account? <button onClick={() => setView('signup')}>Sign up</button></>
                            ) : (
                                <>Already have an account? <button onClick={() => setView('login')}>Sign in</button></>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ============ STUDENT DASHBOARD CONTENT (Reusable) ============
        const StudentDashboardContent = ({ user, updateUser, stocks, searchQuery, setSearchQuery, selectedStock, setSelectedStock, showTradeModal, setShowTradeModal, executeTrade, onSearch, loading, setStocks, setLoading }) => {
            const [activeTab, setActiveTab] = useState('portfolio');

            const totalValue = user.balance + user.portfolio.reduce((sum, holding) => {
                const stock = stocks.find(s => s.symbol === holding.symbol);
                return sum + (stock ? stock.price * holding.shares : 0);
            }, 0);

            const totalGain = totalValue - 100000;
            const totalGainPercent = (totalGain / 100000) * 100;

            return (
                <>
                    <nav className="tabs" style={{borderBottom: '2px solid var(--border)', marginBottom: '2rem'}}>
                        <button className={`tab ${activeTab === 'portfolio' ? 'active' : ''}`} onClick={() => setActiveTab('portfolio')}>
                            Portfolio
                        </button>
                        <button className={`tab ${activeTab === 'market' ? 'active' : ''}`} onClick={() => setActiveTab('market')}>
                            Market
                        </button>
                        <button className={`tab ${activeTab === 'transactions' ? 'active' : ''}`} onClick={() => setActiveTab('transactions')}>
                            Transactions
                        </button>
                    </nav>

                    {activeTab === 'portfolio' && (
                        <PortfolioView 
                            user={user} 
                            stocks={stocks}
                            totalValue={totalValue}
                            totalGain={totalGain}
                            totalGainPercent={totalGainPercent}
                            onTrade={(stock) => {
                                setSelectedStock(stock);
                                setShowTradeModal(true);
                            }}
                        />
                    )}

                    {activeTab === 'market' && (
                        <MarketView 
                            stocks={stocks}
                            searchQuery={searchQuery}
                            setSearchQuery={setSearchQuery}
                            onTrade={(stock) => {
                                setSelectedStock(stock);
                                setShowTradeModal(true);
                            }}
                            onSearch={onSearch}
                            loading={loading}
                            setStocks={setStocks}
                            setLoading={setLoading}
                        />
                    )}

                    {activeTab === 'transactions' && (
                        <TransactionsView transactions={user.transactions} stocks={stocks} />
                    )}
                </>
            );
        };

        // ============ STUDENT DASHBOARD ============
        const StudentDashboard = ({ user, updateUser, logout }) => {
            const [activeTab, setActiveTab] = useState('portfolio');
            const [selectedStock, setSelectedStock] = useState(null);
            const [showTradeModal, setShowTradeModal] = useState(false);
            const [stocks, setStocks] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [data, setData] = useState(loadData());

            // Load stocks only after dashboard mounts (after login!)
            useEffect(() => {
                const loadInitialStocks = async () => {
                    setLoading(true);
                    try {
                        const initialStocks = await searchStocks('');
                        setStocks(initialStocks);
                    } catch (error) {
                        console.error('Error loading stocks:', error);
                    }
                    setLoading(false);
                };
                loadInitialStocks();
            }, []);

            // Get the student's class research links
            const teacherCode = data.teacherCodes.find(c => c.code === user.teacherCode);
            const researchLinks = teacherCode?.researchLinks || [];


            const totalValue = user.balance + user.portfolio.reduce((sum, holding) => {
                const stock = stocks.find(s => s.symbol === holding.symbol);
                return sum + (stock ? stock.price * holding.shares : 0);
            }, 0);

            const totalGain = totalValue - 100000;
            const totalGainPercent = (totalGain / 100000) * 100;

            const executeTrade = (symbol, shares, type) => {
                const stock = stocks.find(s => s.symbol === symbol);
                if (!stock) return;

                const cost = stock.price * shares;

                if (type === 'buy') {
                    if (cost > user.balance) {
                        alert('Insufficient funds');
                        return;
                    }

                    const existingHolding = user.portfolio.find(h => h.symbol === symbol);
                    const newPortfolio = existingHolding
                        ? user.portfolio.map(h => 
                            h.symbol === symbol 
                                ? { ...h, shares: h.shares + shares, avgCost: ((h.avgCost * h.shares) + cost) / (h.shares + shares) }
                                : h
                          )
                        : [...user.portfolio, { symbol, shares, avgCost: stock.price, purchaseDate: new Date().toISOString() }];

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'buy',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    const updatedUser = {
                        ...user,
                        balance: user.balance - cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...user.transactions]
                    };
                    
                    updateUser(updatedUser);
                } else {
                    const holding = user.portfolio.find(h => h.symbol === symbol);
                    if (!holding || holding.shares < shares) {
                        alert('Insufficient shares');
                        return;
                    }

                    const newPortfolio = holding.shares === shares
                        ? user.portfolio.filter(h => h.symbol !== symbol)
                        : user.portfolio.map(h => 
                            h.symbol === symbol ? { ...h, shares: h.shares - shares } : h
                          );

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'sell',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    const updatedUser = {
                        ...user,
                        balance: user.balance + cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...user.transactions]
                    };
                    
                    updateUser(updatedUser);
                }

                setShowTradeModal(false);
            };

            const handleSearch = async () => {
                setLoading(true);
                try {
                    const results = await searchStocks(searchQuery);
                    setStocks(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
                setLoading(false);
            };

            

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">MarketMentor</div>
                        <div className="header-right">
                            <div className="user-info">
                                <div>
                                    <div style={{fontSize: '0.85rem', color: 'var(--text-muted)'}}>Portfolio Value</div>
                                    <div className="balance-display">${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                </div>
                            </div>
                            <button className="btn btn-secondary" onClick={logout}>Logout</button>
                        </div>
                    </header>

                    <div className="dashboard">
                        <nav className="sidebar">
                            <div className={`nav-item ${activeTab === 'portfolio' ? 'active' : ''}`} onClick={() => setActiveTab('portfolio')}>
                                <span className="nav-icon">ðŸ“Š</span>
                                <span>Portfolio</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'market' ? 'active' : ''}`} onClick={() => setActiveTab('market')}>
                                <span className="nav-icon">ðŸ“ˆ</span>
                                <span>Market</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'transactions' ? 'active' : ''}`} onClick={() => setActiveTab('transactions')}>
                                <span className="nav-icon">ðŸ’³</span>
                                <span>Transactions</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'research' ? 'active' : ''}`} onClick={() => setActiveTab('research')}>
                                <span className="nav-icon">ðŸ”</span>
                                <span>Research</span>
                            </div>
                        </nav>

                        <main className="main-content">
                            {activeTab === 'portfolio' && (
                                <PortfolioView 
                                    user={user} 
                                    stocks={stocks}
                                    totalValue={totalValue}
                                    totalGain={totalGain}
                                    totalGainPercent={totalGainPercent}
                                    onTrade={(stock) => {
                                        setSelectedStock(stock);
                                        setShowTradeModal(true);
                                    }}
                                />
                            )}

                            {activeTab === 'market' && (
                                <MarketView 
                                    stocks={stocks}
                                    searchQuery={searchQuery}
                                    setSearchQuery={setSearchQuery}
                                    onTrade={(stock) => {
                                        setSelectedStock(stock);
                                        setShowTradeModal(true);
                                    }}
                                    onSearch={handleSearch}
                                    loading={loading}
                                    setStocks={setStocks}
                                    setLoading={setLoading}
                                />
                            )}

                            {activeTab === 'transactions' && (
                                <TransactionsView transactions={user.transactions} stocks={stocks} />
                            )}

                            {activeTab === 'research' && (
                                <ResearchView links={researchLinks} />
                            )}
                        </main>
                    </div>

                    {showTradeModal && (
                        <TradeModal
                            stock={selectedStock}
                            user={user}
                            onClose={() => setShowTradeModal(false)}
                            onTrade={executeTrade}
                        />
                    )}
                </div>
            );
        };

        // ============ PORTFOLIO VIEW ============
        const PortfolioView = ({ user, stocks, totalValue, totalGain, totalGainPercent, onTrade }) => {
            const [historicalPeriod, setHistoricalPeriod] = useState(null);
            const [historicalData, setHistoricalData] = useState(null);
            const [loadingHistorical, setLoadingHistorical] = useState(false);

            const timePeriods = [
                { label: 'Current', years: 0 },
                { label: '1 Year', years: 1 },
                { label: '2 Years', years: 2 },
                { label: '5 Years', years: 5 },
                { label: '10 Years', years: 10 },
                { label: '20 Years', years: 20 },
                { label: '30 Years', years: 30 }
            ];

            const loadHistoricalReturns = async (years) => {
                if (years === 0) {
                    setHistoricalPeriod(0);
                    setHistoricalData(null);
                    return;
                }

                setLoadingHistorical(true);
                setHistoricalPeriod(years);
                
                const data = await calculateHistoricalReturns(user.portfolio, stocks, years);
                setHistoricalData(data);
                setLoadingHistorical(false);
            };

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Portfolio Overview</h2>
                    
                    <div style={{background: 'var(--bg-secondary)', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem', border: '1px solid var(--border-highlight)'}}>
                        <p style={{color: 'var(--text-secondary)', fontSize: '0.85rem'}}>
                            ðŸ“Œ <strong>Note:</strong> Portfolio values reflect stock price changes only. Dividends are not currently included in calculations.
                        </p>
                    </div>

                    {/* Time Period Buttons */}
                    {user.portfolio.length > 0 && (
                        <div style={{marginBottom: '2rem'}}>
                            <div style={{marginBottom: '1rem'}}>
                                <strong style={{color: 'var(--text-secondary)', fontSize: '0.9rem'}}>
                                    ðŸ“Š Historical Performance Calculator
                                </strong>
                                <p style={{color: 'var(--text-muted)', fontSize: '0.85rem', marginTop: '0.3rem'}}>
                                    See what your portfolio would be worth if you invested the same amounts years ago
                                </p>
                            </div>
                            <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                {timePeriods.map(period => (
                                    <button
                                        key={period.years}
                                        className={`btn ${historicalPeriod === period.years ? 'btn-primary' : 'btn-secondary'}`}
                                        style={{padding: '0.5rem 1rem', fontSize: '0.85rem'}}
                                        onClick={() => loadHistoricalReturns(period.years)}
                                        disabled={loadingHistorical}
                                    >
                                        {period.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Historical Returns Display */}
                    {loadingHistorical && (
                        <div style={{textAlign: 'center', padding: '2rem', background: 'var(--bg-card)', borderRadius: '12px', marginBottom: '2rem', border: '1px solid var(--border)'}}>
                            <div className="spinner"></div>
                            <p style={{color: 'var(--text-muted)', marginTop: '1rem'}}>
                                Calculating {historicalPeriod}-year returns...
                            </p>
                        </div>
                    )}

                    {!loadingHistorical && historicalData && (
                        <div style={{
                            background: 'linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%)',
                            borderRadius: '12px',
                            padding: '1.5rem',
                            marginBottom: '2rem',
                            border: '2px solid var(--accent-green)',
                            boxShadow: '0 8px 24px rgba(0, 255, 136, 0.1)'
                        }}>
                            <h3 style={{marginBottom: '1rem', color: 'var(--accent-green)'}}>
                                ðŸ“ˆ {historicalPeriod}-Year Historical Returns
                            </h3>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem'}}>
                                <div>
                                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.3rem'}}>
                                        Amount Invested
                                    </div>
                                    <div style={{fontSize: '1.3rem', fontWeight: '700', fontFamily: 'JetBrains Mono, monospace'}}>
                                        ${historicalData.invested.toLocaleString('en-US', {minimumFractionDigits: 2})}
                                    </div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.3rem'}}>
                                        Current Value
                                    </div>
                                    <div style={{fontSize: '1.3rem', fontWeight: '700', fontFamily: 'JetBrains Mono, monospace', color: 'var(--accent-green)'}}>
                                        ${historicalData.currentValue.toLocaleString('en-US', {minimumFractionDigits: 2})}
                                    </div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.3rem'}}>
                                        Total Return
                                    </div>
                                    <div style={{
                                        fontSize: '1.3rem',
                                        fontWeight: '700',
                                        fontFamily: 'JetBrains Mono, monospace',
                                        color: historicalData.totalReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'
                                    }}>
                                        {historicalData.totalReturn >= 0 ? '+' : ''}${historicalData.totalReturn.toLocaleString('en-US', {minimumFractionDigits: 2})}
                                        <span style={{fontSize: '0.9rem', marginLeft: '0.5rem'}}>
                                            ({historicalData.returnPercent >= 0 ? '+' : ''}{historicalData.returnPercent.toFixed(2)}%)
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.3rem'}}>
                                        Annualized Return
                                    </div>
                                    <div style={{
                                        fontSize: '1.3rem',
                                        fontWeight: '700',
                                        fontFamily: 'JetBrains Mono, monospace',
                                        color: historicalData.annualizedReturn >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'
                                    }}>
                                        {historicalData.annualizedReturn >= 0 ? '+' : ''}{historicalData.annualizedReturn.toFixed(2)}%/yr
                                    </div>
                                </div>
                            </div>
                            <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '1rem', fontStyle: 'italic'}}>
                                * Analyzed {historicalData.stocksAnalyzed} of {user.portfolio.length} stocks. Some stocks may not have been publicly traded {historicalPeriod} years ago.
                            </p>
                        </div>
                    )}

                    {!loadingHistorical && historicalPeriod !== null && historicalPeriod !== 0 && !historicalData && (
                        <div className="alert alert-info" style={{marginBottom: '2rem'}}>
                            <strong>No Historical Data Available</strong>
                            <p style={{marginTop: '0.5rem', fontSize: '0.9rem'}}>
                                None of the stocks in your portfolio were publicly traded {historicalPeriod} years ago. Try a shorter time period.
                            </p>
                        </div>
                    )}

                    <div className="portfolio-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Value</div>
                            <div className="stat-value">${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Cash Balance</div>
                            <div className="stat-value">${user.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Total Gain/Loss</div>
                            <div className={`stat-value ${totalGain >= 0 ? 'stat-change positive' : 'stat-change negative'}`}>
                                ${Math.abs(totalGain).toLocaleString('en-US', {minimumFractionDigits: 2})}
                            </div>
                            <div className={totalGainPercent >= 0 ? 'stat-change positive' : 'stat-change negative'}>
                                {totalGainPercent >= 0 ? '+' : ''}{totalGainPercent.toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Holdings</div>
                        </div>
                        {user.portfolio.length === 0 ? (
                            <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                <p style={{fontSize: '1.2rem', marginBottom: '1rem'}}>No holdings yet</p>
                                <p>Start trading to build your portfolio!</p>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Shares</th>
                                        <th>Avg Cost</th>
                                        <th>Current Price</th>
                                        <th>Total Value</th>
                                        <th>Gain/Loss</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {user.portfolio.map(holding => {
                                        const stock = stocks.find(s => s.symbol === holding.symbol) || { price: holding.avgCost };
                                        const totalValue = stock.price * holding.shares;
                                        const totalCost = holding.avgCost * holding.shares;
                                        const gainLoss = totalValue - totalCost;
                                        const gainLossPercent = (gainLoss / totalCost) * 100;
                                        
                                        return (
                                            <tr key={holding.symbol}>
                                                <td className="stock-symbol">{holding.symbol}</td>
                                                <td>{holding.shares}</td>
                                                <td>${holding.avgCost.toFixed(2)}</td>
                                                <td>${stock.price.toFixed(2)}</td>
                                                <td>${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                                <td>
                                                    <div className={gainLoss >= 0 ? 'stat-change positive' : 'stat-change negative'}>
                                                        ${Math.abs(gainLoss).toFixed(2)}
                                                        <br/>
                                                        ({gainLossPercent >= 0 ? '+' : ''}{gainLossPercent.toFixed(2)}%)
                                                    </div>
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn btn-primary" 
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => onTrade(stock)}
                                                    >
                                                        Trade
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        };

        // ============ MARKET VIEW ============
        const MarketView = ({ stocks, searchQuery, setSearchQuery, onTrade, onSearch, loading, setStocks, setLoading }) => {
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    onSearch();
                }
            };

            const handleClear = async () => {
                setSearchQuery('');
                setLoading(true);
                try {
                    const defaultStocks = await searchStocks('');
                    setStocks(defaultStocks);
                } catch (error) {
                    console.error('Error loading default stocks:', error);
                }
                setLoading(false);
            };

            // Calculate market movers (only show when not searching)
            const topGainers = !searchQuery && stocks.length > 0 
                ? [...stocks].sort((a, b) => b.changePercent - a.changePercent).slice(0, 5)
                : [];
            
            const topLosers = !searchQuery && stocks.length > 0
                ? [...stocks].sort((a, b) => a.changePercent - b.changePercent).slice(0, 5)
                : [];

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Market</h2>

                    <div className="search-bar">
                        <input
                            type="text"
                            className="form-input search-input"
                            placeholder="Search stocks by symbol (e.g., TSLA, AAPL, NVDA, GME)..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            onKeyPress={handleKeyPress}
                        />
                        <button 
                            className="btn btn-primary" 
                            onClick={onSearch}
                            disabled={loading}
                        >
                            {loading ? 'Searching...' : 'Search'}
                        </button>
                        {searchQuery && (
                            <button 
                                className="btn btn-secondary" 
                                onClick={handleClear}
                                disabled={loading}
                            >
                                Clear
                            </button>
                        )}
                    </div>

                    {loading && (
                        <div style={{textAlign: 'center', padding: '2rem'}}>
                            <div className="spinner"></div>
                            <p style={{color: 'var(--text-muted)', marginTop: '1rem'}}>Loading stocks...</p>
                        </div>
                    )}

                    {!loading && !searchQuery && (
                        <>
                            <div className="market-movers-grid" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginBottom: '2rem'}}>
                                {/* Top Gainers */}
                                <div className="table-container">
                                    <div className="table-header">
                                        <div className="table-title">ðŸš€ Top Gainers</div>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Price</th>
                                                <th>Change</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {topGainers.map(stock => (
                                                <tr key={stock.symbol}>
                                                    <td className="stock-symbol">{stock.symbol}</td>
                                                    <td>${stock.price.toFixed(2)}</td>
                                                    <td>
                                                        <div className="stat-change positive">
                                                            +{stock.changePercent.toFixed(2)}%
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button 
                                                            className="btn btn-primary" 
                                                            style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                            onClick={() => onTrade(stock)}
                                                        >
                                                            Trade
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Top Losers */}
                                <div className="table-container">
                                    <div className="table-header">
                                        <div className="table-title">ðŸ“‰ Top Losers</div>
                                    </div>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Price</th>
                                                <th>Change</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {topLosers.map(stock => (
                                                <tr key={stock.symbol}>
                                                    <td className="stock-symbol">{stock.symbol}</td>
                                                    <td>${stock.price.toFixed(2)}</td>
                                                    <td>
                                                        <div className="stat-change negative">
                                                            {stock.changePercent.toFixed(2)}%
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button 
                                                            className="btn btn-primary" 
                                                            style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                            onClick={() => onTrade(stock)}
                                                        >
                                                            Trade
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}

                    {!loading && (
                        <div className="table-container">
                            <div className="table-header">
                                <div className="table-title">
                                    {searchQuery ? `Search Results for "${searchQuery}"` : 'Popular Stocks'}
                                </div>
                            </div>
                            {stocks.length === 0 ? (
                                <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                    <p style={{fontSize: '1.2rem', marginBottom: '1rem'}}>No stocks found</p>
                                    <p>Try searching for a stock symbol like TSLA, AAPL, NVDA, GME, or DIS</p>
                                </div>
                            ) : (
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Change</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {stocks.map(stock => (
                                            <tr key={stock.symbol}>
                                                <td className="stock-symbol">{stock.symbol}</td>
                                                <td>{stock.name}</td>
                                                <td>${stock.price.toFixed(2)}</td>
                                                <td>
                                                    <div className={stock.change >= 0 ? 'stat-change positive' : 'stat-change negative'}>
                                                        ${Math.abs(stock.change).toFixed(2)}
                                                        <br/>
                                                        ({stock.changePercent >= 0 ? '+' : ''}{stock.changePercent.toFixed(2)}%)
                                                    </div>
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn btn-primary" 
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => onTrade(stock)}
                                                    >
                                                        Trade
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    )}

                    {/* API Status - Bottom of page */}
                    <div style={{marginTop: '3rem', padding: '0.75rem', textAlign: 'center', borderTop: '1px solid var(--border)'}}>
                        {FINNHUB_API_KEY === 'YOUR_API_KEY_HERE' ? (
                            <p style={{color: 'var(--text-muted)', fontSize: '0.8rem'}}>
                                âš ï¸ Using mock data. <a href="https://finnhub.io/register" target="_blank" style={{color: 'var(--accent-blue)'}}>Add API key</a> to line 742 for real-time prices.
                            </p>
                        ) : (
                            <p style={{color: 'var(--text-muted)', fontSize: '0.8rem'}}>
                                âœ… Live market data from Finnhub
                            </p>
                        )}
                    </div>
                </div>
            );
        };

        // ============ TRANSACTIONS VIEW ============
        const TransactionsView = ({ transactions, stocks }) => {
            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Transaction History</h2>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Recent Transactions</div>
                        </div>
                        {transactions.length === 0 ? (
                            <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                No transactions yet
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Symbol</th>
                                        <th>Shares</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {transactions.map(tx => (
                                        <tr key={tx.id}>
                                            <td>{new Date(tx.date).toLocaleDateString()}</td>
                                            <td>
                                                <span style={{
                                                    fontWeight: '600',
                                                    color: tx.type === 'buy' ? 'var(--accent-green)' : 'var(--accent-red)'
                                                }}>
                                                    {tx.type.toUpperCase()}
                                                </span>
                                            </td>
                                            <td className="stock-symbol">{tx.symbol}</td>
                                            <td>{tx.shares}</td>
                                            <td>${tx.price.toFixed(2)}</td>
                                            <td>${tx.total.toFixed(2)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        };

        // ============ RESEARCH VIEW ============
        const ResearchView = ({ links }) => {
            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Research Resources</h2>
                    
                    <div style={{background: 'var(--bg-secondary)', padding: '1rem', borderRadius: '8px', marginBottom: '2rem', border: '1px solid var(--border-highlight)'}}>
                        <p style={{color: 'var(--text-secondary)', fontSize: '0.9rem'}}>
                            ðŸ“š Your teacher has curated these resources to help you research stocks and learn about investing.
                        </p>
                    </div>

                    {links.length === 0 ? (
                        <div className="table-container">
                            <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                <p style={{fontSize: '1.2rem', marginBottom: '1rem'}}>No research links yet</p>
                                <p>Your teacher will add helpful resources soon!</p>
                            </div>
                        </div>
                    ) : (
                        <div className="portfolio-grid">
                            {links.map((link, index) => (
                                <a 
                                    key={index}
                                    href={link.url} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    style={{textDecoration: 'none'}}
                                >
                                    <div className="stat-card" style={{cursor: 'pointer', height: '100%'}}>
                                        <div className="control-icon">ðŸ”—</div>
                                        <div className="control-title" style={{color: 'var(--accent-green)', marginBottom: '0.5rem'}}>
                                            {link.name}
                                        </div>
                                        <p className="control-desc" style={{color: 'var(--text-secondary)'}}>
                                            {link.description}
                                        </p>
                                    </div>
                                </a>
                            ))}
                        </div>
                    )}

                    <div className="table-container" style={{marginTop: '2rem'}}>
                        <div className="table-header">
                            <div className="table-title">Research Tips</div>
                        </div>
                        <div style={{padding: '2rem'}}>
                            <h3 style={{marginBottom: '1rem'}}>How to Research a Stock</h3>
                            <p style={{marginBottom: '1rem', lineHeight: '1.6', color: 'var(--text-secondary)'}}>
                                1. <strong>Check the financials:</strong> Look at revenue, profit margins, and debt levels
                            </p>
                            <p style={{marginBottom: '1rem', lineHeight: '1.6', color: 'var(--text-secondary)'}}>
                                2. <strong>Read the news:</strong> Stay updated on company announcements and industry trends
                            </p>
                            <p style={{marginBottom: '1rem', lineHeight: '1.6', color: 'var(--text-secondary)'}}>
                                3. <strong>Compare competitors:</strong> How does the company stack up against rivals?
                            </p>
                            <p style={{lineHeight: '1.6', color: 'var(--text-secondary)'}}>
                                4. <strong>Understand the business:</strong> What does the company do and how do they make money?
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ TRADE MODAL ============
        const TradeModal = ({ stock, user, onClose, onTrade }) => {
            const [tradeType, setTradeType] = useState('buy');
            const [shares, setShares] = useState(1);

            const holding = user.portfolio.find(h => h.symbol === stock.symbol);
            const maxShares = tradeType === 'sell' ? (holding?.shares || 0) : Math.floor(user.balance / stock.price);
            const total = stock.price * shares;

            const handleTrade = () => {
                if (shares <= 0) {
                    alert('Please enter a valid number of shares');
                    return;
                }
                onTrade(stock.symbol, shares, tradeType);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <div>
                                <h2 className="modal-title">{stock.symbol}</h2>
                                <p style={{color: 'var(--text-muted)'}}>{stock.name}</p>
                            </div>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <div className="tabs">
                            <button 
                                className={`tab ${tradeType === 'buy' ? 'active' : ''}`}
                                onClick={() => setTradeType('buy')}
                            >
                                Buy
                            </button>
                            <button 
                                className={`tab ${tradeType === 'sell' ? 'active' : ''}`}
                                onClick={() => setTradeType('sell')}
                            >
                                Sell
                            </button>
                        </div>

                        <div className="transaction-form">
                            <div>
                                <div className="stat-label">Current Price</div>
                                <div style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--accent-green)'}}>
                                    ${stock.price.toFixed(2)}
                                </div>
                            </div>

                            {tradeType === 'sell' && (
                                <div>
                                    <div className="stat-label">You Own</div>
                                    <div style={{fontSize: '1.2rem', fontWeight: '600'}}>
                                        {holding?.shares || 0} shares
                                    </div>
                                </div>
                            )}

                            <div>
                                <div className="stat-label">Shares to {tradeType}</div>
                                <div className="quantity-selector">
                                    <button 
                                        className="quantity-btn"
                                        onClick={() => setShares(Math.max(1, shares - 1))}
                                    >
                                        -
                                    </button>
                                    <input
                                        type="number"
                                        className="form-input quantity-input"
                                        value={shares}
                                        onChange={(e) => setShares(Math.max(1, parseInt(e.target.value) || 1))}
                                        min="1"
                                        max={maxShares}
                                    />
                                    <button 
                                        className="quantity-btn"
                                        onClick={() => setShares(Math.min(maxShares, shares + 1))}
                                    >
                                        +
                                    </button>
                                </div>
                                <p style={{fontSize: '0.85rem', color: 'var(--text-muted)', marginTop: '0.5rem'}}>
                                    Max: {maxShares} shares
                                </p>
                            </div>

                            <div className="transaction-summary">
                                <div className="summary-row">
                                    <span>Shares</span>
                                    <span>{shares}</span>
                                </div>
                                <div className="summary-row">
                                    <span>Price per Share</span>
                                    <span>${stock.price.toFixed(2)}</span>
                                </div>
                                <div className="summary-row">
                                    <span>Total</span>
                                    <span>${total.toFixed(2)}</span>
                                </div>
                            </div>

                            <button 
                                className={`btn ${tradeType === 'buy' ? 'btn-primary' : 'btn-danger'}`}
                                style={{width: '100%'}}
                                onClick={handleTrade}
                                disabled={shares > maxShares}
                            >
                                {tradeType === 'buy' ? 'Buy' : 'Sell'} {shares} Shares
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ TEACHER DASHBOARD ============
        const TeacherDashboard = ({ teacher, logout, data, setData }) => {
            const [activeTab, setActiveTab] = useState('overview');
            const [stocks, setStocks] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedStock, setSelectedStock] = useState(null);
            const [showTradeModal, setShowTradeModal] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');

            // Load stocks when teacher dashboard mounts
            useEffect(() => {
                const loadStocks = async () => {
                    setLoading(true);
                    try {
                        const initialStocks = await searchStocks('');
                        setStocks(initialStocks);
                    } catch (error) {
                        console.error('Error loading stocks:', error);
                    }
                    setLoading(false);
                };
                loadStocks();
            }, []);

            const generateCode = () => {
                const code = Math.random().toString(36).substring(2, 10).toUpperCase();
                const newCode = {
                    code,
                    teacherId: teacher.id,
                    className: 'New Class',
                    createdAt: new Date().toISOString(),
                    researchLinks: [
                        { name: 'Yahoo Finance', url: 'https://finance.yahoo.com', description: 'Stock quotes, news, and financial data' },
                        { name: 'Investopedia', url: 'https://www.investopedia.com', description: 'Financial education and definitions' },
                        { name: 'MarketWatch', url: 'https://www.marketwatch.com', description: 'Market news and stock analysis' },
                        { name: 'SEC Filings (EDGAR)', url: 'https://www.sec.gov/edgar/searchedgar/companysearch.html', description: 'Official company filings and reports' }
                    ]
                };
                setData({...data, teacherCodes: [...data.teacherCodes, newCode]});
                return code;
            };

            const students = data.users.filter(u => {
                const userCode = data.teacherCodes.find(c => c.code === u.teacherCode);
                return userCode && userCode.teacherId === teacher.id;
            });

            const updateTeacher = (updatedTeacher) => {
                const teachers = data.teachers.map(t => 
                    t.id === updatedTeacher.id ? updatedTeacher : t
                );
                setData({...data, teachers});
            };

            const executeTeacherTrade = (symbol, shares, type) => {
                const stock = stocks.find(s => s.symbol === symbol);
                if (!stock) return;

                const cost = stock.price * shares;

                if (type === 'buy') {
                    if (cost > teacher.balance) {
                        alert('Insufficient funds');
                        return;
                    }

                    const existingHolding = teacher.portfolio.find(h => h.symbol === symbol);
                    const newPortfolio = existingHolding
                        ? teacher.portfolio.map(h => 
                            h.symbol === symbol 
                                ? { ...h, shares: h.shares + shares, avgCost: ((h.avgCost * h.shares) + cost) / (h.shares + shares) }
                                : h
                          )
                        : [...teacher.portfolio, { symbol, shares, avgCost: stock.price, purchaseDate: new Date().toISOString() }];

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'buy',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    const updatedTeacher = {
                        ...teacher,
                        balance: teacher.balance - cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...teacher.transactions]
                    };
                    
                    updateTeacher(updatedTeacher);
                } else {
                    const holding = teacher.portfolio.find(h => h.symbol === symbol);
                    if (!holding || holding.shares < shares) {
                        alert('Insufficient shares');
                        return;
                    }

                    const newPortfolio = holding.shares === shares
                        ? teacher.portfolio.filter(h => h.symbol !== symbol)
                        : teacher.portfolio.map(h => 
                            h.symbol === symbol ? { ...h, shares: h.shares - shares } : h
                          );

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'sell',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    const updatedTeacher = {
                        ...teacher,
                        balance: teacher.balance + cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...teacher.transactions]
                    };
                    
                    updateTeacher(updatedTeacher);
                }

                setShowTradeModal(false);
            };

            const handleSearch = async () => {
                setLoading(true);
                try {
                    const results = await searchStocks(searchQuery);
                    setStocks(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
                setLoading(false);
            };

            

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">MarketMentor <span style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Teacher</span></div>
                        <div className="header-right">
                            <div style={{color: 'var(--text-secondary)'}}>
                                {teacher.name}
                            </div>
                            <button className="btn btn-secondary" onClick={logout}>Logout</button>
                        </div>
                    </header>

                    <div className="dashboard">
                        <nav className="sidebar">
                            <div className={`nav-item ${activeTab === 'overview' ? 'active' : ''}`} onClick={() => setActiveTab('overview')}>
                                <span className="nav-icon">ðŸ“Š</span>
                                <span>Overview</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'my-portfolio' ? 'active' : ''}`} onClick={() => setActiveTab('my-portfolio')}>
                                <span className="nav-icon">ðŸ’¼</span>
                                <span>My Portfolio</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'students' ? 'active' : ''}`} onClick={() => setActiveTab('students')}>
                                <span className="nav-icon">ðŸ‘¥</span>
                                <span>Students</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'classes' ? 'active' : ''}`} onClick={() => setActiveTab('classes')}>
                                <span className="nav-icon">ðŸ«</span>
                                <span>Classes</span>
                            </div>
                            <div className={`nav-item ${activeTab === 'reports' ? 'active' : ''}`} onClick={() => setActiveTab('reports')}>
                                <span className="nav-icon">ðŸ“ˆ</span>
                                <span>Reports</span>
                            </div>
                        </nav>

                        <main className="main-content">
                            {activeTab === 'overview' && (
                                <TeacherOverview 
                                    students={students}
                                    stocks={stocks}
                                    generateCode={generateCode}
                                    teacherCodes={data.teacherCodes.filter(c => c.teacherId === teacher.id)}
                                />
                            )}

                            {activeTab === 'my-portfolio' && (
                                <div>
                                    <div style={{background: 'var(--bg-secondary)', padding: '1rem', borderRadius: '8px', marginBottom: '2rem', border: '1px solid var(--accent-blue)'}}>
                                        <strong>Teacher Demo Portfolio</strong>
                                        <p style={{color: 'var(--text-muted)', fontSize: '0.9rem', marginTop: '0.5rem'}}>
                                            Use this portfolio to demonstrate trading to your students. This is separate from student portfolios.
                                        </p>
                                    </div>
                                    <StudentDashboardContent 
                                        user={teacher}
                                        updateUser={updateTeacher}
                                        stocks={stocks}
                                        searchQuery={searchQuery}
                                        setSearchQuery={setSearchQuery}
                                        selectedStock={selectedStock}
                                        setSelectedStock={setSelectedStock}
                                        showTradeModal={showTradeModal}
                                        setShowTradeModal={setShowTradeModal}
                                        executeTrade={executeTeacherTrade}
                                        onSearch={handleSearch}
                                        loading={loading}
                                        setStocks={setStocks}
                                        setLoading={setLoading}
                                    />
                                </div>
                            )}

                            {activeTab === 'students' && (
                                <TeacherStudentsView 
                                    students={students}
                                    data={data}
                                    setData={setData}
                                />
                            )}

                            {activeTab === 'classes' && (
                                <TeacherClassesView 
                                    teacherCodes={data.teacherCodes.filter(c => c.teacherId === teacher.id)}
                                    data={data}
                                    setData={setData}
                                />
                            )}

                            {activeTab === 'reports' && (
                                <TeacherReportsView students={students} stocks={stocks} />
                            )}
                        </main>
                    </div>

                    {showTradeModal && (
                        <TradeModal
                            stock={selectedStock}
                            user={teacher}
                            onClose={() => setShowTradeModal(false)}
                            onTrade={executeTeacherTrade}
                        />
                    )}
                </div>
            );
        };

        // ============ TEACHER OVERVIEW ============
        const TeacherOverview = ({ students, generateCode, teacherCodes, stocks = [] }) => {
            const [showCodeModal, setShowCodeModal] = useState(false);
            const [newCode, setNewCode] = useState('');

            const handleGenerateCode = () => {
                const code = generateCode();
                setNewCode(code);
                setShowCodeModal(true);
            };

            const totalPortfolioValue = students.reduce((sum, student) => {
                const studentValue = student.balance + student.portfolio.reduce((pSum, holding) => {
                    const stock = stocks.find(s => s.symbol === holding.symbol) || { price: holding.avgCost };
                    return pSum + (stock.price * holding.shares);
                }, 0);
                return sum + studentValue;
            }, 0);

            const avgPerformance = students.length > 0 
                ? students.reduce((sum, student) => {
                    const portfolioValue = student.balance + student.portfolio.reduce((pSum, holding) => {
                        const stock = stocks.find(s => s.symbol === holding.symbol) || { price: holding.avgCost };
                        return pSum + (stock.price * holding.shares);
                    }, 0);
                    const performance = ((portfolioValue - 100000) / 100000 * 100);
                    return sum + performance;
                }, 0) / students.length
                : 0;

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Teacher Dashboard</h2>

                    <div className="portfolio-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Students</div>
                            <div className="stat-value">{students.length}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Active Classes</div>
                            <div className="stat-value">{teacherCodes.length}</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-label">Avg Performance</div>
                            <div className={`stat-value ${avgPerformance >= 0 ? 'stat-change positive' : 'stat-change negative'}`}>
                                {avgPerformance >= 0 ? '+' : ''}{avgPerformance.toFixed(2)}%
                            </div>
                        </div>

                        <div className="stat-card">
                            <div className="stat-label">Total Portfolio Value</div>
                            <div className="stat-value" style={{fontSize: '1.5rem'}}>
                                ${totalPortfolioValue.toLocaleString('en-US', {minimumFractionDigits: 2})}
                            </div>
                        </div>
                    </div>

                    <div className="teacher-controls">
                        <div className="control-card" onClick={handleGenerateCode}>
                            <div className="control-icon">ðŸ”‘</div>
                            <div className="control-title">Generate Class Code</div>
                            <p className="control-desc">Create a new access code for students</p>
                        </div>
                    </div>

                    {showCodeModal && (
                        <div className="modal-overlay" onClick={() => setShowCodeModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">New Class Code</h2>
                                    <button className="close-btn" onClick={() => setShowCodeModal(false)}>Ã—</button>
                                </div>
                                <div style={{textAlign: 'center', padding: '2rem'}}>
                                    <p style={{marginBottom: '1rem'}}>Share this code with your students:</p>
                                    <div style={{
                                        fontSize: '2.5rem',
                                        fontWeight: '700',
                                        fontFamily: 'JetBrains Mono, monospace',
                                        color: 'var(--accent-green)',
                                        padding: '1.5rem',
                                        background: 'var(--bg-tertiary)',
                                        borderRadius: '12px',
                                        letterSpacing: '4px'
                                    }}>
                                        {newCode}
                                    </div>
                                    <p style={{marginTop: '1rem', color: 'var(--text-muted)', fontSize: '0.9rem'}}>
                                        Students will use this code during signup
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Recent Student Activity</div>
                        </div>
                        {students.length === 0 ? (
                            <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                <p style={{fontSize: '1.2rem', marginBottom: '1rem'}}>No students yet</p>
                                <p>Generate a class code to get started!</p>
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Portfolio Value</th>
                                        <th>Performance</th>
                                        <th>Holdings</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.slice(0, 10).map(student => {
                                        const portfolioValue = student.balance + student.portfolio.reduce((sum, holding) => {
                                            const stock = stocks.find(s => s.symbol === holding.symbol) || { price: holding.avgCost };
                                            return sum + (stock.price * holding.shares);
                                        }, 0);
                                        const performance = ((portfolioValue - 100000) / 100000 * 100);
                                        
                                        return (
                                            <tr key={student.id}>
                                                <td>{student.name}</td>
                                                <td>${portfolioValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                                <td>
                                                    <span className={performance >= 0 ? 'stat-change positive' : 'stat-change negative'}>
                                                        {performance >= 0 ? '+' : ''}{performance.toFixed(2)}%
                                                    </span>
                                                </td>
                                                <td>{student.portfolio.length}</td>
                                                <td>{student.transactions.length > 0 ? new Date(student.transactions[0].date).toLocaleDateString() : 'No activity'}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>
            );
        };

        // ============ TEACHER STUDENTS VIEW ============
        const TeacherStudentsView = ({ students, data, setData }) => {
            const [editingStudent, setEditingStudent] = useState(null);
            const [balanceInput, setBalanceInput] = useState('');

            const adjustBalance = (studentId, newBalance) => {
                const users = data.users.map(u => 
                    u.id === studentId ? { ...u, balance: parseFloat(newBalance) } : u
                );
                setData({...data, users});
                setEditingStudent(null);
                setBalanceInput('');
            };

            const resetStudent = (studentId) => {
                if (confirm('Are you sure you want to reset this student\'s portfolio? This cannot be undone.')) {
                    const users = data.users.map(u => 
                        u.id === studentId ? { 
                            ...u, 
                            balance: 100000,
                            portfolio: [],
                            transactions: []
                        } : u
                    );
                    setData({...data, users});
                }
            };

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Student Management</h2>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">All Students</div>
                        </div>
                        {students.length === 0 ? (
                            <div style={{padding: '3rem', textAlign: 'center', color: 'var(--text-muted)'}}>
                                No students enrolled yet
                            </div>
                        ) : (
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Username</th>
                                        <th>Balance</th>
                                        <th>Holdings</th>
                                        <th>Transactions</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students.map(student => (
                                        <tr key={student.id}>
                                            <td>{student.name}</td>
                                            <td className="stock-symbol">{student.username}</td>
                                            <td>
                                                {editingStudent === student.id ? (
                                                    <div style={{display: 'flex', gap: '0.5rem'}}>
                                                        <input
                                                            type="number"
                                                            className="form-input"
                                                            style={{width: '120px', padding: '0.3rem'}}
                                                            value={balanceInput}
                                                            onChange={(e) => setBalanceInput(e.target.value)}
                                                            placeholder={student.balance.toFixed(2)}
                                                            autoFocus
                                                        />
                                                        <button 
                                                            className="btn btn-primary"
                                                            style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                            onClick={() => adjustBalance(student.id, balanceInput)}
                                                        >
                                                            Save
                                                        </button>
                                                    </div>
                                                ) : (
                                                    <span>${student.balance.toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
                                                )}
                                            </td>
                                            <td>{student.portfolio.length}</td>
                                            <td>{student.transactions.length}</td>
                                            <td>
                                                <div style={{display: 'flex', gap: '0.5rem'}}>
                                                    <button 
                                                        className="btn btn-secondary"
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => {
                                                            setEditingStudent(student.id);
                                                            setBalanceInput(student.balance.toString());
                                                        }}
                                                    >
                                                        Adjust Balance
                                                    </button>
                                                    <button 
                                                        className="btn btn-danger"
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => resetStudent(student.id)}
                                                    >
                                                        Reset
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>

                    {students.length > 0 && (
                        <div className="table-container" style={{marginTop: '2rem'}}>
                            <div className="table-header">
                                <div className="table-title">Recent Transactions</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Student</th>
                                        <th>Type</th>
                                        <th>Symbol</th>
                                        <th>Shares</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {students
                                        .flatMap(s => s.transactions.map(tx => ({...tx, studentName: s.name})))
                                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                                        .slice(0, 20)
                                        .map(tx => (
                                            <tr key={tx.id}>
                                                <td>{new Date(tx.date).toLocaleDateString()}</td>
                                                <td>{tx.studentName}</td>
                                                <td>
                                                    <span style={{
                                                        fontWeight: '600',
                                                        color: tx.type === 'buy' ? 'var(--accent-green)' : 'var(--accent-red)'
                                                    }}>
                                                        {tx.type.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td className="stock-symbol">{tx.symbol}</td>
                                                <td>{tx.shares}</td>
                                                <td>${tx.price.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // ============ TEACHER CLASSES VIEW ============
        const TeacherClassesView = ({ teacherCodes, data, setData }) => {
            const [editingCode, setEditingCode] = useState(null);
            const [editingLinks, setEditingLinks] = useState(null);
            const [linksData, setLinksData] = useState([]);

            const updateClassName = (code, newName) => {
                const codes = data.teacherCodes.map(c => 
                    c.code === code ? { ...c, className: newName } : c
                );
                setData({...data, teacherCodes: codes});
                setEditingCode(null);
            };

            const deleteCode = (code) => {
                if (confirm('Are you sure you want to delete this class code?')) {
                    const codes = data.teacherCodes.filter(c => c.code !== code);
                    setData({...data, teacherCodes: codes});
                }
            };

            const startEditingLinks = (code) => {
                const classCode = teacherCodes.find(c => c.code === code);
                setLinksData(classCode.researchLinks || []);
                setEditingLinks(code);
            };

            const saveLinks = (code) => {
                const codes = data.teacherCodes.map(c => 
                    c.code === code ? { ...c, researchLinks: linksData } : c
                );
                setData({...data, teacherCodes: codes});
                setEditingLinks(null);
            };

            const addLink = () => {
                setLinksData([...linksData, { name: '', url: '', description: '' }]);
            };

            const updateLink = (index, field, value) => {
                const newLinks = [...linksData];
                newLinks[index][field] = value;
                setLinksData(newLinks);
            };

            const deleteLink = (index) => {
                setLinksData(linksData.filter((_, i) => i !== index));
            };

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Class Management</h2>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Active Classes</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Class Name</th>
                                    <th>Access Code</th>
                                    <th>Students</th>
                                    <th>Research Links</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {teacherCodes.map(code => {
                                    const studentCount = data.users.filter(u => u.teacherCode === code.code).length;
                                    const linkCount = code.researchLinks?.length || 0;
                                    
                                    return (
                                        <tr key={code.code}>
                                            <td>
                                                {editingCode === code.code ? (
                                                    <input
                                                        type="text"
                                                        className="form-input"
                                                        defaultValue={code.className}
                                                        onBlur={(e) => updateClassName(code.code, e.target.value)}
                                                        onKeyPress={(e) => {
                                                            if (e.key === 'Enter') {
                                                                updateClassName(code.code, e.target.value);
                                                            }
                                                        }}
                                                        autoFocus
                                                    />
                                                ) : (
                                                    <span onClick={() => setEditingCode(code.code)} style={{cursor: 'pointer'}}>
                                                        {code.className}
                                                    </span>
                                                )}
                                            </td>
                                            <td>
                                                <span className="stock-symbol">{code.code}</span>
                                            </td>
                                            <td>{studentCount}</td>
                                            <td>{linkCount} links</td>
                                            <td>
                                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                    <button 
                                                        className="btn btn-secondary" 
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => setEditingCode(code.code)}
                                                    >
                                                        Rename
                                                    </button>
                                                    <button 
                                                        className="btn btn-primary" 
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => startEditingLinks(code.code)}
                                                    >
                                                        Edit Links
                                                    </button>
                                                    <button 
                                                        className="btn btn-danger" 
                                                        style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                        onClick={() => deleteCode(code.code)}
                                                    >
                                                        Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {/* Research Links Editor Modal */}
                    {editingLinks && (
                        <div className="modal-overlay" onClick={() => setEditingLinks(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Edit Research Links</h2>
                                    <button className="close-btn" onClick={() => setEditingLinks(null)}>Ã—</button>
                                </div>

                                <div style={{maxHeight: '60vh', overflowY: 'auto', padding: '1rem'}}>
                                    {linksData.map((link, index) => (
                                        <div key={index} style={{
                                            background: 'var(--bg-tertiary)', 
                                            padding: '1rem', 
                                            borderRadius: '8px', 
                                            marginBottom: '1rem',
                                            border: '1px solid var(--border)'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                                                <strong>Link {index + 1}</strong>
                                                <button 
                                                    className="btn btn-danger" 
                                                    style={{padding: '0.3rem 0.8rem', fontSize: '0.8rem'}}
                                                    onClick={() => deleteLink(index)}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Name</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={link.name}
                                                    onChange={(e) => updateLink(index, 'name', e.target.value)}
                                                    placeholder="e.g., Yahoo Finance"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">URL</label>
                                                <input
                                                    type="url"
                                                    className="form-input"
                                                    value={link.url}
                                                    onChange={(e) => updateLink(index, 'url', e.target.value)}
                                                    placeholder="https://..."
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Description</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={link.description}
                                                    onChange={(e) => updateLink(index, 'description', e.target.value)}
                                                    placeholder="Brief description of the resource"
                                                />
                                            </div>
                                        </div>
                                    ))}

                                    <button 
                                        className="btn btn-secondary" 
                                        style={{width: '100%', marginTop: '1rem'}}
                                        onClick={addLink}
                                    >
                                        + Add New Link
                                    </button>
                                </div>

                                <div style={{padding: '1rem', borderTop: '1px solid var(--border)', marginTop: '1rem'}}>
                                    <button 
                                        className="btn btn-primary" 
                                        style={{width: '100%'}}
                                        onClick={() => saveLinks(editingLinks)}
                                    >
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ============ TEACHER REPORTS VIEW ============
        const TeacherReportsView = ({ students, stocks = [] }) => {
            const topPerformers = [...students]
                .map(student => {
                    const portfolioValue = student.balance + student.portfolio.reduce((sum, holding) => {
                        const stock = stocks.find(s => s.symbol === holding.symbol) || { symbol: holding.symbol, price: holding.avgCost };
                        return sum + (stock ? stock.price * holding.shares : 0);
                    }, 0);
                    const performance = ((portfolioValue - 100000) / 100000 * 100);
                    return { ...student, portfolioValue, performance };
                })
                .sort((a, b) => b.performance - a.performance)
                .slice(0, 10);

            return (
                <div className="fade-in">
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Performance Reports</h2>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Top Performers</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Student</th>
                                    <th>Portfolio Value</th>
                                    <th>Performance</th>
                                    <th>Holdings</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {topPerformers.map((student, index) => (
                                    <tr key={student.id}>
                                        <td>
                                            <span style={{
                                                fontSize: '1.5rem',
                                                fontWeight: '700',
                                                color: index === 0 ? 'var(--accent-yellow)' : 
                                                       index === 1 ? 'var(--text-secondary)' : 
                                                       index === 2 ? '#cd7f32' : 'var(--text-muted)'
                                            }}>
                                                {index + 1}
                                            </span>
                                        </td>
                                        <td>{student.name}</td>
                                        <td>${student.portfolioValue.toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                                        <td>
                                            <span className={student.performance >= 0 ? 'stat-change positive' : 'stat-change negative'}>
                                                {student.performance >= 0 ? '+' : ''}{student.performance.toFixed(2)}%
                                            </span>
                                        </td>
                                        <td>{student.portfolio.length}</td>
                                        <td>{student.transactions.length}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ============ RENDER APP ============
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
