<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketMentor - Stock Market Simulation</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #00894b;
            --primary-blue: #0066b2;
            --bg-white: #ffffff;
            --bg-light: #f7f8fa;
            --bg-gray: #e8eaed;
            --text-dark: #333333;
            --text-gray: #5f6368;
            --text-light: #80868b;
            --border-light: #dadce0;
            --success-green: #00894b;
            --loss-red: #d32f2f;
            --hover-bg: #f1f3f4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            font-family: 'Lato', sans-serif;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .balance-info {
            text-align: right;
        }

        .balance-label {
            font-size: 0.75rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .balance-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            font-family: 'Open Sans', sans-serif;
        }

        .btn-primary {
            background: var(--primary-green);
            color: white;
        }

        .btn-primary:hover {
            background: #007038;
        }

        .btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        .btn-danger {
            background: var(--loss-red);
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        /* Auth Screen */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
        }

        .auth-card {
            background: white;
            border-radius: 8px;
            padding: 3rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            font-family: 'Lato', sans-serif;
        }

        .auth-subtitle {
            color: var(--text-gray);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 1rem;
            font-family: 'Open Sans', sans-serif;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 178, 0.1);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-gray);
        }

        .auth-switch button {
            background: none;
            border: none;
            color: var(--primary-blue);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .error-message {
            background: #fdecea;
            border: 1px solid var(--loss-red);
            color: var(--loss-red);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        /* Dashboard */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tabs {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
            margin: -2rem -2rem 2rem -2rem;
            padding: 0 2rem;
            display: flex;
            gap: 2rem;
        }

        .tab {
            background: none;
            border: none;
            padding: 1rem 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-dark);
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        /* Summary View */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .summary-card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .summary-card-title svg {
            width: 20px;
            height: 20px;
            fill: var(--text-gray);
        }

        .balance-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .balance-change {
            font-size: 1rem;
            font-weight: 600;
        }

        .balance-change.positive {
            color: var(--success-green);
        }

        .balance-change.negative {
            color: var(--loss-red);
        }

        .performance-metrics {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .performance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--bg-gray);
        }

        .performance-row:last-child {
            border-bottom: none;
        }

        .performance-label {
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .performance-value {
            font-weight: 700;
            font-size: 1rem;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .table-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-light);
        }

        th {
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-light);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--bg-gray);
            color: var(--text-dark);
        }

        tbody tr:hover {
            background: var(--bg-light);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .symbol-cell {
            font-weight: 700;
            color: var(--primary-blue);
            font-size: 1rem;
        }

        .price-cell {
            font-family: monospace;
            font-weight: 600;
        }

        .gain-positive {
            color: var(--success-green);
            font-weight: 600;
        }

        .gain-negative {
            color: var(--loss-red);
            font-weight: 600;
        }

        /* Search */
        .search-container {
            margin-bottom: 1.5rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 178, 0.1);
        }

        /* Market Movers */
        .movers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mover-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid transparent;
        }

        .mover-card.gainer {
            border-left-color: var(--success-green);
        }

        .mover-card.loser {
            border-left-color: var(--loss-red);
        }

        .mover-symbol {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
        }

        .mover-price {
            font-family: monospace;
            color: var(--text-gray);
            font-size: 0.95rem;
        }

        .mover-change {
            font-weight: 700;
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-gray);
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .trade-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .trade-type-btn {
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            background: white;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trade-type-btn.active {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
        }

        .trade-summary {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .trade-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .spinner {
            border: 3px solid var(--bg-gray);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-gray);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Teacher Specific Styles */
        .teacher-actions {
            display: flex;
            gap: 0.5rem;
        }

        .student-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }

        .class-code {
            background: var(--bg-light);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary-blue);
            display: inline-block;
        }

        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid var(--primary-blue);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ============ CONSTANTS ============
        const FINNHUB_API_KEY = 'd5e0i19r01qjckl13iagd5e0i19r01qjckl13ib0';
        const DEFAULT_SYMBOLS = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META', 'JPM'];

        // ============ DATA MANAGEMENT ============
        const loadData = () => {
            const stored = localStorage.getItem('marketMentorData');
            if (stored) {
                return JSON.parse(stored);
            }
            return {
                users: [],
                teachers: [],
                teacherCodes: []
            };
        };

        const saveData = (data) => {
            localStorage.setItem('marketMentorData', JSON.stringify(data));
        };

        // ============ API FUNCTIONS ============
        const fetchStockPrice = async (symbol) => {
            try {
                const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.c && data.c > 0) {
                    return {
                        symbol: symbol,
                        price: data.c,
                        change: data.d,
                        changePercent: data.dp,
                        high: data.h,
                        low: data.l,
                        open: data.o,
                        previousClose: data.pc
                    };
                }
                throw new Error('Invalid data');
            } catch (error) {
                // Mock data fallback
                const mockPrice = 100 + Math.random() * 400;
                const mockChange = (Math.random() - 0.5) * 10;
                return {
                    symbol: symbol,
                    price: mockPrice,
                    change: mockChange,
                    changePercent: (mockChange / mockPrice) * 100,
                    high: mockPrice + Math.random() * 5,
                    low: mockPrice - Math.random() * 5,
                    open: mockPrice,
                    previousClose: mockPrice - mockChange,
                    error: true
                };
            }
        };

        const searchStocks = async (query) => {
            if (!query || query.length < 1) {
                // Load default stocks
                const stocks = [];
                for (const symbol of DEFAULT_SYMBOLS) {
                    const stock = await fetchStockPrice(symbol);
                    stocks.push(stock);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                return stocks;
            }
            
            // First, try direct symbol lookup
            const cleanQuery = query.trim().toUpperCase();
            try {
                const directStock = await fetchStockPrice(cleanQuery);
                if (!directStock.error) {
                    return [directStock];
                }
            } catch (error) {
                console.log('Direct lookup failed, trying search...');
            }
            
            // If direct lookup fails, try search endpoint
            try {
                const url = `https://finnhub.io/api/v1/search?q=${query}&token=${FINNHUB_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.result || data.result.length === 0) {
                    return [];
                }
                
                const symbols = data.result
                    .filter(r => r.type === 'Common Stock')
                    .map(r => r.symbol)
                    .slice(0, 10);
                
                const stocks = [];
                for (const symbol of symbols) {
                    const stock = await fetchStockPrice(symbol);
                    if (!stock.error) {
                        stocks.push(stock);
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                return stocks;
            } catch (error) {
                console.error('Search error:', error);
                return [];
            }
        };

        // ============ MAIN APP COMPONENT ============
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [isTeacher, setIsTeacher] = useState(false);
            const [view, setView] = useState('login');
            const [data, setData] = useState(() => {
                const stored = loadData();
                return stored;
            });

            useEffect(() => {
                saveData(data);
            }, [data]);

            const login = (username, password, asTeacher = false) => {
                const users = asTeacher ? data.teachers : data.users;
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    if (!asTeacher && user.isPaused) {
                        return 'paused'; // Account is paused
                    }
                    setCurrentUser(user);
                    setIsTeacher(asTeacher);
                    return true;
                }
                return false;
            };

            const logout = () => {
                setCurrentUser(null);
                setIsTeacher(false);
            };

            const signup = (userData) => {
                const newUser = {
                    id: Date.now(),
                    ...userData,
                    balance: 100000,
                    portfolio: [],
                    transactions: []
                };

                const updatedData = {
                    ...data,
                    [userData.isTeacher ? 'teachers' : 'users']: [
                        ...(userData.isTeacher ? data.teachers : data.users),
                        newUser
                    ]
                };
                
                setData(updatedData);
                setCurrentUser(newUser);
                setIsTeacher(userData.isTeacher);
            };

            const updateUser = (updatedUser) => {
                if (isTeacher) {
                    const updatedTeachers = data.teachers.map(t => 
                        t.id === updatedUser.id ? updatedUser : t
                    );
                    setData({ ...data, teachers: updatedTeachers });
                    setCurrentUser(updatedUser);
                } else {
                    const updatedUsers = data.users.map(u => 
                        u.id === updatedUser.id ? updatedUser : u
                    );
                    setData({ ...data, users: updatedUsers });
                    setCurrentUser(updatedUser);
                }
            };

            if (!currentUser) {
                return <AuthScreen view={view} setView={setView} login={login} signup={signup} data={data} />;
            }

            return isTeacher ? (
                <TeacherDashboard teacher={currentUser} logout={logout} data={data} setData={setData} />
            ) : (
                <StudentDashboard user={currentUser} updateUser={updateUser} logout={logout} data={data} />
            );
        };

        // ============ AUTH SCREEN ============
        const AuthScreen = ({ view, setView, login, signup, data }) => {
            const [formData, setFormData] = useState({
                username: '',
                password: '',
                name: '',
                teacherCode: '',
                isTeacher: false
            });
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                if (view === 'login') {
                    const success = login(formData.username, formData.password, formData.isTeacher);
                    if (success === 'paused') {
                        setError('Your account has been paused by your teacher. Please contact them for assistance.');
                    } else if (!success) {
                        setError('Invalid username or password');
                    }
                } else {
                    // Validate signup
                    if (!formData.username || !formData.password || !formData.name) {
                        setError('Please fill in all fields');
                        return;
                    }

                    if (!formData.isTeacher && !formData.teacherCode) {
                        setError('Please enter a class code');
                        return;
                    }

                    if (!formData.isTeacher) {
                        const validCode = data.teacherCodes.find(c => c.code === formData.teacherCode);
                        if (!validCode) {
                            setError('Invalid class code');
                            return;
                        }
                    }

                    signup(formData);
                }
            };

            return (
                <div className="auth-container">
                    <div className="auth-card">
                        <h1 className="auth-title">MarketMentor</h1>
                        <p className="auth-subtitle">
                            {view === 'login' ? 'Sign in to your account' : 'Create your account'}
                        </p>

                        {error && <div className="error-message">{error}</div>}

                        <form onSubmit={handleSubmit}>
                            {view === 'signup' && (
                                <div className="form-group">
                                    <label className="form-label">Full Name</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        placeholder="Enter your name"
                                    />
                                </div>
                            )}

                            <div className="form-group">
                                <label className="form-label">Username</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={formData.username}
                                    onChange={(e) => setFormData({...formData, username: e.target.value})}
                                    placeholder="Enter username"
                                />
                            </div>

                            <div className="form-group">
                                <label className="form-label">Password</label>
                                <input
                                    type="password"
                                    className="form-input"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                    placeholder="Enter password"
                                />
                            </div>

                            {view === 'signup' && !formData.isTeacher && (
                                <div className="form-group">
                                    <label className="form-label">Class Code</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.teacherCode}
                                        onChange={(e) => setFormData({...formData, teacherCode: e.target.value})}
                                        placeholder="Enter class code from your teacher"
                                    />
                                </div>
                            )}

                            <div className="form-checkbox">
                                <input
                                    type="checkbox"
                                    id="isTeacher"
                                    checked={formData.isTeacher}
                                    onChange={(e) => setFormData({...formData, isTeacher: e.target.checked})}
                                />
                                <label htmlFor="isTeacher">I am a teacher</label>
                            </div>

                            <button type="submit" className="btn btn-primary" style={{width: '100%'}}>
                                {view === 'login' ? 'Sign In' : 'Create Account'}
                            </button>
                        </form>

                        <div className="auth-switch">
                            {view === 'login' ? (
                                <>
                                    Don't have an account?{' '}
                                    <button onClick={() => setView('signup')}>Sign up</button>
                                </>
                            ) : (
                                <>
                                    Already have an account?{' '}
                                    <button onClick={() => setView('login')}>Sign in</button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ============ STUDENT DASHBOARD ============
        const StudentDashboard = ({ user, updateUser, logout, data }) => {
            const [activeTab, setActiveTab] = useState('summary');
            const [selectedStock, setSelectedStock] = useState(null);
            const [showTradeModal, setShowTradeModal] = useState(false);
            const [stocks, setStocks] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [loading, setLoading] = useState(false);
            const [lastRefresh, setLastRefresh] = useState(null);
            const [refreshCooldown, setRefreshCooldown] = useState(0);

            useEffect(() => {
                const loadInitialStocks = async () => {
                    setLoading(true);
                    try {
                        const initialStocks = await searchStocks('');
                        setStocks(initialStocks);
                    } catch (error) {
                        console.error('Error loading stocks:', error);
                    }
                    setLoading(false);
                };
                loadInitialStocks();

                // Check and apply interest and dividends if due
                const checkAndApplyInterestDividends = () => {
                    const teacherCode = data.teacherCodes.find(c => c.code === user.teacherCode);
                    if (!teacherCode) return;

                    // Check for per-student overrides or use class defaults
                    const studentInterestRate = user.interestRateOverride !== undefined ? user.interestRateOverride : teacherCode.interestRate;
                    const studentInterestFreq = user.interestFrequencyOverride !== undefined ? user.interestFrequencyOverride : teacherCode.interestFrequency;
                    const studentDividendAmount = user.dividendAmountOverride !== undefined ? user.dividendAmountOverride : teacherCode.dividendAmount;
                    const studentDividendFreq = user.dividendFrequencyOverride !== undefined ? user.dividendFrequencyOverride : teacherCode.dividendFrequency;

                    let updatedUser = { ...user };
                    let hasUpdates = false;

                    // Apply Interest
                    if (studentInterestRate && studentInterestRate > 0 && studentInterestFreq) {
                        const lastInterestDate = user.lastInterestDate ? new Date(user.lastInterestDate) : new Date(user.createdDate || Date.now());
                        const daysSinceLastInterest = Math.floor((new Date() - lastInterestDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysSinceLastInterest >= studentInterestFreq) {
                            const interestAmount = updatedUser.balance * (studentInterestRate / 100);
                            updatedUser.balance += interestAmount;
                            updatedUser.lastInterestDate = new Date().toISOString();
                            
                            const transaction = {
                                id: Date.now() + Math.random(),
                                symbol: 'INTEREST',
                                type: 'interest',
                                shares: 0,
                                price: 0,
                                total: interestAmount,
                                date: new Date().toISOString()
                            };
                            updatedUser.transactions = [transaction, ...updatedUser.transactions];
                            hasUpdates = true;
                            console.log(`Applied ${studentInterestRate}% interest: $${interestAmount.toFixed(2)}`);
                        }
                    }

                    // Apply Dividend
                    if (studentDividendAmount && studentDividendAmount > 0 && studentDividendFreq) {
                        const lastDividendDate = user.lastDividendDate ? new Date(user.lastDividendDate) : new Date(user.createdDate || Date.now());
                        const daysSinceLastDividend = Math.floor((new Date() - lastDividendDate) / (1000 * 60 * 60 * 24));
                        
                        let daysRequired = 1;
                        switch(studentDividendFreq) {
                            case 'daily': daysRequired = 1; break;
                            case 'bi-daily': daysRequired = 2; break;
                            case 'tri-daily': daysRequired = 3; break;
                            case 'weekly': daysRequired = 7; break;
                            case 'bi-weekly': daysRequired = 14; break;
                            case 'monthly': daysRequired = 30; break;
                        }
                        
                        if (daysSinceLastDividend >= daysRequired) {
                            updatedUser.balance += studentDividendAmount;
                            updatedUser.lastDividendDate = new Date().toISOString();
                            
                            const transaction = {
                                id: Date.now() + Math.random() + 0.1,
                                symbol: 'DIVIDEND',
                                type: 'dividend',
                                shares: 0,
                                price: 0,
                                total: studentDividendAmount,
                                date: new Date().toISOString()
                            };
                            updatedUser.transactions = [transaction, ...updatedUser.transactions];
                            hasUpdates = true;
                            console.log(`Applied class dividend: $${studentDividendAmount.toFixed(2)}`);
                        }
                    }

                    if (hasUpdates) {
                        updateUser(updatedUser);
                    }
                };
                
                checkAndApplyInterestDividends();

                // Auto-refresh stock prices every 15 minutes
                const refreshInterval = setInterval(async () => {
                    try {
                        console.log('Auto-refreshing stock prices...');
                        const refreshedStocks = await searchStocks('');
                        setStocks(refreshedStocks);
                    } catch (error) {
                        console.error('Auto-refresh error:', error);
                    }
                }, 15 * 60 * 1000); // 15 minutes in milliseconds

                // Cleanup interval on unmount
                return () => clearInterval(refreshInterval);
            }, []);

            // Cooldown timer effect
            useEffect(() => {
                if (refreshCooldown > 0) {
                    const timer = setTimeout(() => {
                        setRefreshCooldown(refreshCooldown - 1);
                    }, 1000);
                    return () => clearTimeout(timer);
                }
            }, [refreshCooldown]);

            const manualRefresh = async () => {
                if (refreshCooldown > 0) {
                    alert(`Please wait ${Math.floor(refreshCooldown / 60)}:${(refreshCooldown % 60).toString().padStart(2, '0')} before refreshing again`);
                    return;
                }

                setLoading(true);
                try {
                    await refreshStockPrices();
                    setLastRefresh(new Date());
                    setRefreshCooldown(10 * 60); // 10 minute cooldown
                    alert('Portfolio prices updated!');
                } catch (error) {
                    console.error('Refresh error:', error);
                    alert('Error refreshing prices. Please try again.');
                }
                setLoading(false);
            };

            const refreshStockPrices = async () => {
                // Refresh prices for all stocks in portfolio and currently displayed stocks
                const uniqueSymbols = [...new Set([
                    ...user.portfolio.map(h => h.symbol),
                    ...stocks.map(s => s.symbol)
                ])];
                
                const updatedStocks = [];
                for (const symbol of uniqueSymbols) {
                    const stock = await fetchStockPrice(symbol);
                    updatedStocks.push(stock);
                    await new Promise(resolve => setTimeout(resolve, 100)); // Small delay to avoid rate limiting
                }
                setStocks(updatedStocks);
            };

            const executeTrade = async (symbol, shares, type) => {
                const stock = stocks.find(s => s.symbol === symbol);
                if (!stock) return;

                const cost = stock.price * shares;

                if (type === 'buy') {
                    if (cost > user.balance) {
                        alert('Insufficient funds');
                        return;
                    }

                    const existingHolding = user.portfolio.find(h => h.symbol === symbol);
                    const newPortfolio = existingHolding
                        ? user.portfolio.map(h => 
                            h.symbol === symbol 
                                ? { ...h, shares: h.shares + shares, avgCost: ((h.avgCost * h.shares) + cost) / (h.shares + shares) }
                                : h
                          )
                        : [...user.portfolio, { symbol, shares, avgCost: stock.price, purchaseDate: new Date().toISOString() }];

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'buy',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    updateUser({
                        ...user,
                        balance: user.balance - cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...user.transactions]
                    });
                } else {
                    const holding = user.portfolio.find(h => h.symbol === symbol);
                    if (!holding || holding.shares < shares) {
                        alert('Insufficient shares');
                        return;
                    }

                    const newPortfolio = holding.shares === shares
                        ? user.portfolio.filter(h => h.symbol !== symbol)
                        : user.portfolio.map(h => 
                            h.symbol === symbol ? { ...h, shares: h.shares - shares } : h
                          );

                    const transaction = {
                        id: Date.now(),
                        symbol,
                        type: 'sell',
                        shares,
                        price: stock.price,
                        total: cost,
                        date: new Date().toISOString()
                    };

                    updateUser({
                        ...user,
                        balance: user.balance + cost,
                        portfolio: newPortfolio,
                        transactions: [transaction, ...user.transactions]
                    });
                }

                setShowTradeModal(false);
                
                // Refresh stock prices after trade
                await refreshStockPrices();
            };

            const handleSearch = async () => {
                setLoading(true);
                try {
                    const results = await searchStocks(searchQuery);
                    setStocks(results);
                } catch (error) {
                    console.error('Search error:', error);
                }
                setLoading(false);
            };

            const totalValue = user.balance + user.portfolio.reduce((sum, holding) => {
                const stock = stocks.find(s => s.symbol === holding.symbol);
                return sum + (stock ? stock.price * holding.shares : 0);
            }, 0);

            const totalGain = totalValue - 100000;
            const totalGainPercent = (totalGain / 100000) * 100;

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">MarketMentor</div>
                        <div className="header-right">
                            <div className="balance-info">
                                <div className="balance-label">Portfolio Value</div>
                                <div className="balance-value">
                                    ${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                            <div className="balance-info">
                                <div className="balance-label">Cash Balance</div>
                                <div className="balance-value" style={{color: 'var(--primary-green)'}}>
                                    ${user.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                            <button className="btn btn-secondary" onClick={logout}>Logout</button>
                        </div>
                    </header>

                    <div className="dashboard-container">
                        <div className="tabs">
                            <button 
                                className={`tab ${activeTab === 'summary' ? 'active' : ''}`}
                                onClick={() => setActiveTab('summary')}
                            >
                                Summary
                            </button>
                            <button 
                                className={`tab ${activeTab === 'positions' ? 'active' : ''}`}
                                onClick={() => setActiveTab('positions')}
                            >
                                Positions
                            </button>
                            <button 
                                className={`tab ${activeTab === 'activity' ? 'active' : ''}`}
                                onClick={() => setActiveTab('activity')}
                            >
                                Activity & Orders
                            </button>
                            <button 
                                className={`tab ${activeTab === 'research' ? 'active' : ''}`}
                                onClick={() => setActiveTab('research')}
                            >
                                Research
                            </button>
                        </div>

                        <div className="fade-in">
                            {activeTab === 'summary' && (
                                <SummaryView 
                                    user={user}
                                    totalValue={totalValue}
                                    totalGain={totalGain}
                                    totalGainPercent={totalGainPercent}
                                    stocks={stocks}
                                    onRefresh={manualRefresh}
                                    refreshCooldown={refreshCooldown}
                                    loading={loading}
                                />
                            )}

                            {activeTab === 'positions' && (
                                <PositionsView 
                                    user={user}
                                    stocks={stocks}
                                    onTrade={(stock) => {
                                        setSelectedStock(stock);
                                        setShowTradeModal(true);
                                    }}
                                    searchQuery={searchQuery}
                                    setSearchQuery={setSearchQuery}
                                    onSearch={handleSearch}
                                    loading={loading}
                                    onRefresh={manualRefresh}
                                    refreshCooldown={refreshCooldown}
                                />
                            )}

                            {activeTab === 'activity' && (
                                <ActivityView transactions={user.transactions} stocks={stocks} />
                            )}

                            {activeTab === 'research' && (
                                <ResearchView data={data} user={user} />
                            )}
                        </div>
                    </div>

                    {showTradeModal && (
                        <TradeModal
                            stock={selectedStock}
                            user={user}
                            onClose={() => setShowTradeModal(false)}
                            onTrade={executeTrade}
                        />
                    )}
                </div>
            );
        };

        // ============ SUMMARY VIEW ============
        const SummaryView = ({ user, totalValue, totalGain, totalGainPercent, stocks, onRefresh, refreshCooldown, loading }) => {
            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem'}}>
                        <h2 style={{fontSize: '1.5rem', margin: 0}}>Portfolio Summary</h2>
                        <button 
                            className="btn btn-primary" 
                            onClick={onRefresh}
                            disabled={refreshCooldown > 0 || loading}
                        >
                            {loading ? 'Refreshing...' : refreshCooldown > 0 
                                ? `Refresh (${Math.floor(refreshCooldown / 60)}:${(refreshCooldown % 60).toString().padStart(2, '0')})`
                                : 'ðŸ”„ Refresh Prices'
                            }
                        </button>
                    </div>

                    <div className="summary-grid">
                        <div className="summary-card">
                            <h3 className="summary-card-title">Balance</h3>
                            <div className="balance-display">
                                ${totalValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </div>
                            <div className={`balance-change ${totalGain >= 0 ? 'positive' : 'negative'}`}>
                                {totalGain >= 0 ? '+' : ''}${Math.abs(totalGain).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} 
                                ({totalGain >= 0 ? '+' : ''}{totalGainPercent.toFixed(2)}%) Today's gain/loss
                            </div>
                            <div style={{marginTop: '1.5rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border-light)'}}>
                                <div style={{fontSize: '0.85rem', color: 'var(--text-gray)', marginBottom: '0.5rem'}}>
                                    Available to trade (all settled)
                                </div>
                                <div style={{fontSize: '1.25rem', fontWeight: '700'}}>
                                    ${user.balance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </div>
                            </div>
                        </div>

                        <div className="summary-card">
                            <h3 className="summary-card-title">Performance</h3>
                            <div className="performance-metrics">
                                <div className="performance-row">
                                    <span className="performance-label">Your 1-day return</span>
                                    <span className={`performance-value ${totalGainPercent >= 0 ? 'gain-positive' : 'gain-negative'}`}>
                                        {totalGainPercent >= 0 ? '+' : ''}{totalGainPercent.toFixed(2)}%
                                    </span>
                                </div>
                                <div className="performance-row">
                                    <span className="performance-label">S&P 500Â® Index</span>
                                    <span className="performance-value gain-positive">+0.46%</span>
                                </div>
                                <div className="performance-row">
                                    <span className="performance-label">Dow Jones U.S. Total Stock Market Index</span>
                                    <span className="performance-value gain-positive">+0.33%</span>
                                </div>
                                <div className="performance-row">
                                    <span className="performance-label">NASDAQ Composite</span>
                                    <span className="performance-value gain-positive">+0.54%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Top Holdings</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Current Value</th>
                                    <th>Total Gain/Loss</th>
                                    <th>% of Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                {user.portfolio.length === 0 ? (
                                    <tr>
                                        <td colSpan="5">
                                            <div className="empty-state">
                                                <div className="empty-state-icon">ðŸ“Š</div>
                                                <p>No positions yet. Start trading to build your portfolio!</p>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    user.portfolio.slice(0, 5).map((holding) => {
                                        const stock = stocks.find(s => s.symbol === holding.symbol) || { price: holding.avgCost };
                                        const currentValue = stock.price * holding.shares;
                                        const totalCost = holding.avgCost * holding.shares;
                                        const gainLoss = currentValue - totalCost;
                                        const percentOfAccount = (currentValue / totalValue) * 100;

                                        return (
                                            <tr key={holding.symbol}>
                                                <td className="symbol-cell">{holding.symbol}</td>
                                                <td>{holding.shares.toLocaleString()}</td>
                                                <td className="price-cell">
                                                    ${currentValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                </td>
                                                <td className={gainLoss >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                    {gainLoss >= 0 ? '+' : ''}${Math.abs(gainLoss).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                </td>
                                                <td>{percentOfAccount.toFixed(2)}%</td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Market Movers - at bottom of summary */}
                    {(() => {
                        const sortedStocks = [...stocks].sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
                        const topGainers = sortedStocks.filter(s => s.changePercent > 0).slice(0, 3);
                        const topLosers = sortedStocks.filter(s => s.changePercent < 0).slice(0, 3);
                        
                        return (
                            <>
                                {topGainers.length > 0 && (
                                    <div style={{marginTop: '2rem'}}>
                                        <h3 style={{marginBottom: '1rem', color: 'var(--text-dark)'}}>ðŸ“ˆ Your Market Movers - Top Gainers</h3>
                                        <div className="movers-grid">
                                            {topGainers.map(stock => (
                                                <div key={stock.symbol} className="mover-card gainer">
                                                    <div className="mover-symbol">{stock.symbol}</div>
                                                    <div className="mover-price">${stock.price.toFixed(2)}</div>
                                                    <div className="mover-change gain-positive">
                                                        +{stock.changePercent.toFixed(2)}%
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {topLosers.length > 0 && (
                                    <div style={{marginTop: '2rem'}}>
                                        <h3 style={{marginBottom: '1rem', color: 'var(--text-dark)'}}>ðŸ“‰ Your Market Movers - Top Losers</h3>
                                        <div className="movers-grid">
                                            {topLosers.map(stock => (
                                                <div key={stock.symbol} className="mover-card loser">
                                                    <div className="mover-symbol">{stock.symbol}</div>
                                                    <div className="mover-price">${stock.price.toFixed(2)}</div>
                                                    <div className="mover-change gain-negative">
                                                        {stock.changePercent.toFixed(2)}%
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </>
                        );
                    })()}
                </div>
            );
        };

        // ============ POSITIONS VIEW ============
        const PositionsView = ({ user, stocks, onTrade, searchQuery, setSearchQuery, onSearch, loading, onRefresh, refreshCooldown }) => {
            const totalValue = user.balance + user.portfolio.reduce((sum, holding) => {
                const stock = stocks.find(s => s.symbol === holding.symbol);
                return sum + (stock ? stock.price * holding.shares : 0);
            }, 0);

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem', gap: '1rem'}}>
                        <div className="search-box" style={{flex: 1}}>
                            <input
                                type="text"
                                className="search-input"
                                placeholder="Search stocks by symbol (e.g., AAPL, TSLA)"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && onSearch()}
                            />
                            <button className="btn btn-primary" onClick={onSearch} disabled={loading}>
                                {loading ? 'Searching...' : 'Search'}
                            </button>
                        </div>
                        <button 
                            className="btn btn-secondary" 
                            onClick={onRefresh}
                            disabled={refreshCooldown > 0 || loading}
                            style={{whiteSpace: 'nowrap'}}
                        >
                            {loading ? 'Refreshing...' : refreshCooldown > 0 
                                ? `Refresh (${Math.floor(refreshCooldown / 60)}:${(refreshCooldown % 60).toString().padStart(2, '0')})`
                                : 'ðŸ”„ Refresh'
                            }
                        </button>
                    </div>

                    {/* Search Results - Right under search bar */}
                    {loading && (
                        <div style={{textAlign: 'center', padding: '2rem'}}>
                            <div className="spinner"></div>
                        </div>
                    )}

                    {!loading && searchQuery && stocks.length > 0 && (
                        <div className="table-container" style={{marginBottom: '2rem'}}>
                            <div className="table-header">
                                <div className="table-title">Search Results</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Last Price</th>
                                        <th>Change</th>
                                        <th>% Change</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stocks.map((stock) => (
                                        <tr key={stock.symbol}>
                                            <td className="symbol-cell">{stock.symbol}</td>
                                            <td className="price-cell">${stock.price.toFixed(2)}</td>
                                            <td className={stock.change >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                {stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}
                                            </td>
                                            <td className={stock.changePercent >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                {stock.changePercent >= 0 ? '+' : ''}{stock.changePercent.toFixed(2)}%
                                            </td>
                                            <td>
                                                <button 
                                                    className="btn btn-primary"
                                                    style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                    onClick={() => onTrade(stock)}
                                                >
                                                    Trade
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {!loading && searchQuery && stocks.length === 0 && (
                        <div className="alert-info" style={{marginBottom: '2rem'}}>
                            No stocks found for "{searchQuery}". Try searching by stock symbol (e.g., AAPL, MSFT, TSLA).
                        </div>
                    )}

                    {/* Your Positions Table */}
                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Your Positions</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Last Price</th>
                                    <th>Today's Gain/Loss $</th>
                                    <th>Total Gain/Loss $</th>
                                    <th>Total Gain/Loss %</th>
                                    <th>Current Value</th>
                                    <th>Quantity</th>
                                    <th>Average Cost</th>
                                    <th>Cost Basis Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {user.portfolio.length === 0 ? (
                                    <tr>
                                        <td colSpan="10">
                                            <div className="empty-state">
                                                <div className="empty-state-icon">ðŸ“Š</div>
                                                <p>No positions yet. Search for stocks above to start trading!</p>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    user.portfolio.map((holding) => {
                                        const stock = stocks.find(s => s.symbol === holding.symbol) || { symbol: holding.symbol, price: holding.avgCost, change: 0 };
                                        const currentValue = stock.price * holding.shares;
                                        const totalCost = holding.avgCost * holding.shares;
                                        const gainLoss = currentValue - totalCost;
                                        const gainLossPercent = (gainLoss / totalCost) * 100;
                                        // Today's gain/loss = how much the stock moved today Ã— shares owned
                                        const todaysGain = stock.change * holding.shares;

                                        return (
                                            <tr key={holding.symbol}>
                                                <td className="symbol-cell">{holding.symbol}</td>
                                                <td className="price-cell">${stock.price.toFixed(2)}</td>
                                                <td className={todaysGain >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                    {todaysGain >= 0 ? '+' : ''}${Math.abs(todaysGain).toFixed(2)}
                                                </td>
                                                <td className={gainLoss >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                    {gainLoss >= 0 ? '+' : ''}${Math.abs(gainLoss).toFixed(2)}
                                                </td>
                                                <td className={gainLossPercent >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                    {gainLossPercent >= 0 ? '+' : ''}{gainLossPercent.toFixed(2)}%
                                                </td>
                                                <td className="price-cell">${currentValue.toFixed(2)}</td>
                                                <td>{holding.shares.toLocaleString()}</td>
                                                <td className="price-cell">${holding.avgCost.toFixed(2)}</td>
                                                <td className="price-cell">${totalCost.toFixed(2)}</td>
                                                <td>
                                                    <button 
                                                        className="btn btn-primary"
                                                        style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                        onClick={() => onTrade(stock)}
                                                    >
                                                        Trade
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ============ ACTIVITY VIEW ============
        const ActivityView = ({ transactions, stocks }) => {
            return (
                <div className="table-container">
                    <div className="table-header">
                        <div className="table-title">Past 30 Days</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Previous Balance</th>
                                <th>New Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {transactions.length === 0 ? (
                                <tr>
                                    <td colSpan="5">
                                        <div className="empty-state">
                                            <div className="empty-state-icon">ðŸ“‹</div>
                                            <p>No transactions yet</p>
                                        </div>
                                    </td>
                                </tr>
                            ) : (
                                transactions.map((transaction, index) => {
                                    const date = new Date(transaction.date).toLocaleDateString('en-US', {
                                        month: 'short',
                                        day: '2-digit',
                                        year: 'numeric'
                                    });

                                    // Calculate running balance BEFORE this transaction
                                    const laterTransactions = transactions.slice(0, index);
                                    const previousBalance = 100000 - laterTransactions.reduce((sum, t) => {
                                        return sum + (t.type === 'buy' ? t.total : -t.total);
                                    }, 0);
                                    
                                    // Calculate balance AFTER this transaction
                                    const newBalance = transaction.type === 'buy' 
                                        ? previousBalance - transaction.total 
                                        : previousBalance + transaction.total;

                                    return (
                                        <tr key={transaction.id}>
                                            <td>{date}</td>
                                            <td>
                                                {transaction.type === 'interest' 
                                                    ? 'INTEREST EARNED (Cash)' 
                                                    : transaction.type === 'dividend'
                                                    ? 'CLASS DIVIDEND (Cash)'
                                                    : `YOU ${transaction.type.toUpperCase()} ${transaction.symbol} (${transaction.shares} shares) (Cash)`
                                                }
                                            </td>
                                            <td className={transaction.type === 'buy' ? 'gain-negative' : 'gain-positive'}>
                                                {transaction.type === 'buy' ? '-' : '+'}${transaction.total.toFixed(2)}
                                            </td>
                                            <td className="price-cell">${previousBalance.toFixed(2)}</td>
                                            <td className="price-cell">${newBalance.toFixed(2)}</td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };

        // ============ RESEARCH VIEW ============
        const ResearchView = ({ data, user }) => {
            // Get the student's class research links
            const teacherCode = data.teacherCodes.find(c => c.code === user.teacherCode);
            const researchLinks = teacherCode?.researchLinks || [
                { name: 'Yahoo Finance', url: 'https://finance.yahoo.com', description: 'Real-time stock quotes and financial news' },
                { name: 'Investopedia', url: 'https://www.investopedia.com', description: 'Learn about investing and finance' },
                { name: 'MarketWatch', url: 'https://www.marketwatch.com', description: 'Latest stock market and financial news' },
                { name: 'SEC Filings (EDGAR)', url: 'https://www.sec.gov/edgar', description: 'Official company filings and reports' }
            ];

            return (
                <div>
                    <div className="alert-info" style={{marginBottom: '2rem'}}>
                        <strong>ðŸ“š Research Resources</strong>
                        <p style={{marginTop: '0.5rem'}}>
                            Your teacher has curated these resources to help you research stocks and learn about investing.
                        </p>
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem', marginBottom: '2rem'}}>
                        {researchLinks.map((link, index) => (
                            <a 
                                key={index}
                                href={link.url} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                style={{textDecoration: 'none'}}
                            >
                                <div style={{
                                    background: 'white',
                                    padding: '1.5rem',
                                    borderRadius: '8px',
                                    boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                    height: '100%',
                                    transition: 'all 0.2s',
                                    border: '2px solid transparent',
                                    cursor: 'pointer'
                                }}
                                onMouseEnter={(e) => {
                                    e.currentTarget.style.borderColor = 'var(--primary-blue)';
                                    e.currentTarget.style.transform = 'translateY(-2px)';
                                    e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                                }}
                                onMouseLeave={(e) => {
                                    e.currentTarget.style.borderColor = 'transparent';
                                    e.currentTarget.style.transform = 'translateY(0)';
                                    e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                }}
                                >
                                    <div style={{fontSize: '2rem', marginBottom: '0.75rem'}}>ðŸ”—</div>
                                    <h3 style={{color: 'var(--primary-blue)', marginBottom: '0.5rem', fontSize: '1.1rem'}}>
                                        {link.name}
                                    </h3>
                                    <p style={{color: 'var(--text-gray)', fontSize: '0.9rem', lineHeight: '1.5'}}>
                                        {link.description}
                                    </p>
                                </div>
                            </a>
                        ))}
                    </div>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Research Tips</div>
                        </div>
                        <div style={{padding: '2rem'}}>
                            <h3 style={{marginBottom: '1.5rem', color: 'var(--text-dark)'}}>How to Research a Stock</h3>
                            <div style={{display: 'grid', gap: '1rem'}}>
                                <div style={{padding: '1rem', background: 'var(--bg-light)', borderRadius: '4px'}}>
                                    <strong style={{color: 'var(--primary-blue)'}}>1. Check the financials:</strong>
                                    <p style={{marginTop: '0.5rem', color: 'var(--text-gray)'}}>
                                        Look at revenue, profit margins, and debt levels to understand the company's financial health
                                    </p>
                                </div>
                                <div style={{padding: '1rem', background: 'var(--bg-light)', borderRadius: '4px'}}>
                                    <strong style={{color: 'var(--primary-blue)'}}>2. Read the news:</strong>
                                    <p style={{marginTop: '0.5rem', color: 'var(--text-gray)'}}>
                                        Stay updated on company announcements, earnings reports, and industry trends
                                    </p>
                                </div>
                                <div style={{padding: '1rem', background: 'var(--bg-light)', borderRadius: '4px'}}>
                                    <strong style={{color: 'var(--primary-blue)'}}>3. Compare competitors:</strong>
                                    <p style={{marginTop: '0.5rem', color: 'var(--text-gray)'}}>
                                        How does the company stack up against rivals in terms of market share and performance?
                                    </p>
                                </div>
                                <div style={{padding: '1rem', background: 'var(--bg-light)', borderRadius: '4px'}}>
                                    <strong style={{color: 'var(--primary-blue)'}}>4. Understand the business:</strong>
                                    <p style={{marginTop: '0.5rem', color: 'var(--text-gray)'}}>
                                        What does the company do and how do they make money? What are their competitive advantages?
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ TRADE MODAL ============
        const TradeModal = ({ stock, user, onClose, onTrade }) => {
            const [tradeType, setTradeType] = useState('buy');
            const [shares, setShares] = useState('');

            const handleTrade = () => {
                const numShares = parseInt(shares);
                if (!numShares || numShares < 1) {
                    alert('Please enter a valid number of shares');
                    return;
                }
                onTrade(stock.symbol, numShares, tradeType);
            };

            const total = stock.price * (parseInt(shares) || 0);
            const currentHolding = user.portfolio.find(h => h.symbol === stock.symbol);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2 className="modal-title">{tradeType === 'buy' ? 'Buy' : 'Sell'} {stock.symbol}</h2>
                            <button className="close-btn" onClick={onClose}>Ã—</button>
                        </div>

                        <div className="modal-body">
                            <div className="trade-type-selector">
                                <button 
                                    className={`trade-type-btn ${tradeType === 'buy' ? 'active' : ''}`}
                                    onClick={() => setTradeType('buy')}
                                >
                                    Buy
                                </button>
                                <button 
                                    className={`trade-type-btn ${tradeType === 'sell' ? 'active' : ''}`}
                                    onClick={() => setTradeType('sell')}
                                >
                                    Sell
                                </button>
                            </div>

                            <div className="form-group">
                                <label className="form-label">Number of Shares</label>
                                <input
                                    type="number"
                                    className="form-input"
                                    value={shares}
                                    onChange={(e) => setShares(e.target.value)}
                                    min="1"
                                    placeholder="Enter number of shares"
                                />
                            </div>

                            <div className="trade-summary">
                                <div className="trade-summary-row">
                                    <span>Current Price:</span>
                                    <strong>${stock.price.toFixed(2)}</strong>
                                </div>
                                <div className="trade-summary-row">
                                    <span>Shares:</span>
                                    <strong>{shares || 0}</strong>
                                </div>
                                <div className="trade-summary-row">
                                    <span>Total:</span>
                                    <strong>${total.toFixed(2)}</strong>
                                </div>
                                {tradeType === 'buy' && (
                                    <div className="trade-summary-row">
                                        <span>Available Cash:</span>
                                        <strong>${user.balance.toFixed(2)}</strong>
                                    </div>
                                )}
                                {tradeType === 'sell' && currentHolding && (
                                    <div className="trade-summary-row">
                                        <span>Shares Owned:</span>
                                        <strong>{currentHolding.shares}</strong>
                                    </div>
                                )}
                            </div>

                            <button 
                                className={`btn ${tradeType === 'buy' ? 'btn-primary' : 'btn-danger'}`}
                                style={{width: '100%', marginTop: '1rem'}}
                                onClick={handleTrade}
                            >
                                {tradeType === 'buy' ? 'Buy' : 'Sell'} {shares} {shares === 1 ? 'Share' : 'Shares'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============ TEACHER DASHBOARD (Simplified) ============
        const TeacherDashboard = ({ teacher, logout, data, setData }) => {
            const [activeTab, setActiveTab] = useState('overview');

            const students = data.users.filter(u => {
                const teacherCode = data.teacherCodes.find(c => c.code === u.teacherCode);
                return teacherCode && teacherCode.teacherId === teacher.id;
            });

            const generateCode = () => {
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                const newCode = {
                    code: code,
                    teacherId: teacher.id,
                    className: 'New Class',
                    createdAt: new Date().toISOString()
                };

                setData({
                    ...data,
                    teacherCodes: [...data.teacherCodes, newCode]
                });

                return code;
            };

            return (
                <div className="app-container">
                    <header className="header">
                        <div className="logo">MarketMentor - Teacher Dashboard</div>
                        <div className="header-right">
                            <button className="btn btn-secondary" onClick={logout}>Logout</button>
                        </div>
                    </header>

                    <div className="dashboard-container">
                        <div className="tabs">
                            <button 
                                className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                                onClick={() => setActiveTab('overview')}
                            >
                                Overview
                            </button>
                            <button 
                                className={`tab ${activeTab === 'students' ? 'active' : ''}`}
                                onClick={() => setActiveTab('students')}
                            >
                                Students
                            </button>
                            <button 
                                className={`tab ${activeTab === 'classes' ? 'active' : ''}`}
                                onClick={() => setActiveTab('classes')}
                            >
                                Classes
                            </button>
                            <button 
                                className={`tab ${activeTab === 'management' ? 'active' : ''}`}
                                onClick={() => setActiveTab('management')}
                            >
                                Student Management
                            </button>
                        </div>

                        <div className="fade-in">
                            {activeTab === 'overview' && (
                                <TeacherOverview 
                                    students={students}
                                    generateCode={generateCode}
                                    teacherCodes={data.teacherCodes.filter(c => c.teacherId === teacher.id)}
                                />
                            )}

                            {activeTab === 'students' && (
                                <TeacherStudentsView 
                                    students={students}
                                    data={data}
                                    setData={setData}
                                />
                            )}

                            {activeTab === 'classes' && (
                                <TeacherClassesView 
                                    teacherCodes={data.teacherCodes.filter(c => c.teacherId === teacher.id)}
                                    data={data}
                                    setData={setData}
                                />
                            )}

                            {activeTab === 'management' && (
                                <StudentManagementView 
                                    teacherCodes={data.teacherCodes.filter(c => c.teacherId === teacher.id)}
                                    students={students}
                                    data={data}
                                    setData={setData}
                                />
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherOverview = ({ students, generateCode, teacherCodes }) => {
            const [showCodeModal, setShowCodeModal] = useState(false);
            const [newCode, setNewCode] = useState('');

            const handleGenerateCode = () => {
                const code = generateCode();
                setNewCode(code);
                setShowCodeModal(true);
            };

            return (
                <div>
                    <div className="alert-info" style={{marginBottom: '2rem'}}>
                        <strong>Welcome, Teacher!</strong>
                        <p style={{marginTop: '0.5rem'}}>Manage your classes and monitor student progress. Generate class codes for students to join.</p>
                    </div>

                    <div className="summary-grid">
                        <div className="summary-card">
                            <h3 className="summary-card-title">Students</h3>
                            <div className="balance-display">{students.length}</div>
                            <p style={{color: 'var(--text-gray)', marginTop: '0.5rem'}}>Total enrolled students</p>
                        </div>

                        <div className="summary-card">
                            <h3 className="summary-card-title">Active Classes</h3>
                            <div className="balance-display">{teacherCodes.length}</div>
                            <p style={{color: 'var(--text-gray)', marginTop: '0.5rem'}}>Class codes created</p>
                        </div>
                    </div>

                    <div className="table-container">
                        <div className="table-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <div className="table-title">Class Codes</div>
                            <button className="btn btn-primary" onClick={handleGenerateCode}>
                                Generate New Code
                            </button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Class Code</th>
                                    <th>Class Name</th>
                                    <th>Students</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody>
                                {teacherCodes.length === 0 ? (
                                    <tr>
                                        <td colSpan="4">
                                            <div className="empty-state">
                                                <div className="empty-state-icon">ðŸŽ“</div>
                                                <p>No class codes yet. Generate one to get started!</p>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    teacherCodes.map((code) => {
                                        const classStudents = students.filter(s => s.teacherCode === code.code);
                                        return (
                                            <tr key={code.code}>
                                                <td><span className="class-code">{code.code}</span></td>
                                                <td>{code.className}</td>
                                                <td>{classStudents.length}</td>
                                                <td>{new Date(code.createdAt).toLocaleDateString()}</td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>

                    {showCodeModal && (
                        <div className="modal-overlay" onClick={() => setShowCodeModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">New Class Code Generated</h2>
                                    <button className="close-btn" onClick={() => setShowCodeModal(false)}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <p style={{marginBottom: '1rem'}}>Share this code with your students:</p>
                                    <div style={{textAlign: 'center', padding: '2rem', background: 'var(--bg-light)', borderRadius: '8px'}}>
                                        <span className="class-code" style={{fontSize: '2rem'}}>{newCode}</span>
                                    </div>
                                    <p style={{marginTop: '1rem', color: 'var(--text-gray)', fontSize: '0.9rem'}}>
                                        Students will use this code during signup to join your class.
                                    </p>
                                    <button 
                                        className="btn btn-primary" 
                                        style={{width: '100%', marginTop: '1.5rem'}}
                                        onClick={() => setShowCodeModal(false)}
                                    >
                                        Done
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TeacherStudentsView = ({ students, data, setData }) => {
            const [editingStudent, setEditingStudent] = useState(null);
            const [balanceInput, setBalanceInput] = useState('');

            const adjustBalance = (studentId, newBalance) => {
                const updatedUsers = data.users.map(u => 
                    u.id === studentId ? { ...u, balance: parseFloat(newBalance) } : u
                );
                setData({ ...data, users: updatedUsers });
                setEditingStudent(null);
            };

            return (
                <div className="table-container">
                    <div className="table-header">
                        <div className="table-title">All Students</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>Portfolio Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {students.length === 0 ? (
                                <tr>
                                    <td colSpan="5">
                                        <div className="empty-state">
                                            <div className="empty-state-icon">ðŸ‘¨â€ðŸŽ“</div>
                                            <p>No students enrolled yet</p>
                                        </div>
                                    </td>
                                </tr>
                            ) : (
                                students.map((student) => {
                                    const portfolioValue = student.balance + student.portfolio.reduce((sum, h) => sum + (h.shares * h.avgCost), 0);
                                    
                                    return (
                                        <tr key={student.id}>
                                            <td>{student.name}</td>
                                            <td>{student.username}</td>
                                            <td className="price-cell">${student.balance.toFixed(2)}</td>
                                            <td className="price-cell">${portfolioValue.toFixed(2)}</td>
                                            <td>
                                                <button 
                                                    className="btn btn-secondary"
                                                    style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                    onClick={() => {
                                                        setEditingStudent(student.id);
                                                        setBalanceInput(student.balance.toString());
                                                    }}
                                                >
                                                    Adjust Balance
                                                </button>
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>

                    {editingStudent && (
                        <div className="modal-overlay" onClick={() => setEditingStudent(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Adjust Student Balance</h2>
                                    <button className="close-btn" onClick={() => setEditingStudent(null)}>Ã—</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-group">
                                        <label className="form-label">New Balance</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={balanceInput}
                                            onChange={(e) => setBalanceInput(e.target.value)}
                                            step="0.01"
                                        />
                                    </div>
                                    <button 
                                        className="btn btn-primary"
                                        style={{width: '100%'}}
                                        onClick={() => adjustBalance(editingStudent, balanceInput)}
                                    >
                                        Update Balance
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TeacherClassesView = ({ teacherCodes, data, setData }) => {
            const [editingLinks, setEditingLinks] = useState(null);
            const [linksData, setLinksData] = useState([]);
            const [editingInterest, setEditingInterest] = useState(null);
            const [interestRate, setInterestRate] = useState('');
            const [interestFrequency, setInterestFrequency] = useState('');
            const [dividendAmount, setDividendAmount] = useState('');
            const [dividendFrequency, setDividendFrequency] = useState('');

            const startEditingLinks = (code) => {
                const teacherCode = data.teacherCodes.find(c => c.code === code);
                setLinksData(teacherCode?.researchLinks || [
                    { name: 'Yahoo Finance', url: 'https://finance.yahoo.com', description: 'Real-time stock quotes and financial news' },
                    { name: 'Investopedia', url: 'https://www.investopedia.com', description: 'Learn about investing and finance' },
                    { name: 'MarketWatch', url: 'https://www.marketwatch.com', description: 'Latest stock market and financial news' },
                    { name: 'SEC Filings (EDGAR)', url: 'https://www.sec.gov/edgar', description: 'Official company filings and reports' }
                ]);
                setEditingLinks(code);
            };

            const startEditingInterest = (code) => {
                const teacherCode = data.teacherCodes.find(c => c.code === code);
                setInterestRate(teacherCode?.interestRate || '0');
                setInterestFrequency(teacherCode?.interestFrequency || '30');
                setDividendAmount(teacherCode?.dividendAmount || '0');
                setDividendFrequency(teacherCode?.dividendFrequency || 'weekly');
                setEditingInterest(code);
            };

            const saveInterest = (code) => {
                const rate = parseFloat(interestRate) || 0;
                const frequency = parseInt(interestFrequency) || 30;
                const divAmount = parseFloat(dividendAmount) || 0;
                const divFreq = dividendFrequency || 'weekly';
                
                const updatedCodes = data.teacherCodes.map(c => 
                    c.code === code ? { 
                        ...c, 
                        interestRate: rate, 
                        interestFrequency: frequency,
                        dividendAmount: divAmount,
                        dividendFrequency: divFreq,
                        lastInterestDate: new Date().toISOString() 
                    } : c
                );
                setData({ ...data, teacherCodes: updatedCodes });
                setEditingInterest(null);
            };

            const saveLinks = (code) => {
                const updatedCodes = data.teacherCodes.map(c => 
                    c.code === code ? { ...c, researchLinks: linksData } : c
                );
                setData({ ...data, teacherCodes: updatedCodes });
                setEditingLinks(null);
            };

            const addLink = () => {
                setLinksData([...linksData, { name: '', url: '', description: '' }]);
            };

            const updateLink = (index, field, value) => {
                const updated = [...linksData];
                updated[index][field] = value;
                setLinksData(updated);
            };

            const deleteLink = (index) => {
                setLinksData(linksData.filter((_, i) => i !== index));
            };

            const deleteCode = (code) => {
                if (confirm('Are you sure you want to delete this class code? Students using this code will no longer be associated with your account.')) {
                    const updatedCodes = data.teacherCodes.filter(c => c.code !== code);
                    setData({ ...data, teacherCodes: updatedCodes });
                }
            };

            const updateClassName = (code, newName) => {
                const updatedCodes = data.teacherCodes.map(c => 
                    c.code === code ? { ...c, className: newName } : c
                );
                setData({ ...data, teacherCodes: updatedCodes });
            };

            return (
                <div>
                    <div className="alert-info" style={{marginBottom: '2rem'}}>
                        <strong>Manage Your Classes</strong>
                        <p style={{marginTop: '0.5rem'}}>
                            Edit class names and customize research links for each class. Students will see these resources in their Research tab.
                        </p>
                    </div>

                    <div className="table-container">
                        <div className="table-header">
                            <div className="table-title">Your Classes</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Class Code</th>
                                    <th>Class Name</th>
                                    <th>Students</th>
                                    <th>Research Links</th>
                                    <th>Interest</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {teacherCodes.length === 0 ? (
                                    <tr>
                                        <td colSpan="6">
                                            <div className="empty-state">
                                                <div className="empty-state-icon">ðŸŽ“</div>
                                                <p>No classes yet. Generate a class code from the Overview tab!</p>
                                            </div>
                                        </td>
                                    </tr>
                                ) : (
                                    teacherCodes.map((code) => {
                                        const classStudents = data.users.filter(u => u.teacherCode === code.code);
                                        const linksCount = code.researchLinks?.length || 4;
                                        const interestRate = code.interestRate || 0;
                                        const interestFrequency = code.interestFrequency || 30;
                                        const dividendAmount = code.dividendAmount || 0;
                                        const dividendFrequency = code.dividendFrequency || 'weekly';
                                        
                                        return (
                                            <tr key={code.code}>
                                                <td><span className="class-code">{code.code}</span></td>
                                                <td>
                                                    <input
                                                        type="text"
                                                        className="form-input"
                                                        style={{padding: '0.5rem', fontSize: '0.9rem'}}
                                                        value={code.className}
                                                        onChange={(e) => updateClassName(code.code, e.target.value)}
                                                    />
                                                </td>
                                                <td>{classStudents.length}</td>
                                                <td>{linksCount} links</td>
                                                <td>
                                                    <div>{interestRate}% every {interestFrequency} days</div>
                                                    <div style={{fontSize: '0.85rem', color: 'var(--text-gray)'}}>
                                                        ${dividendAmount} {dividendFrequency}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                        <button 
                                                            className="btn btn-primary"
                                                            style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                            onClick={() => startEditingLinks(code.code)}
                                                        >
                                                            Edit Links
                                                        </button>
                                                        <button 
                                                            className="btn btn-secondary"
                                                            style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                            onClick={() => startEditingInterest(code.code)}
                                                        >
                                                            Edit Interest
                                                        </button>
                                                        <button 
                                                            className="btn btn-danger"
                                                            style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                            onClick={() => deleteCode(code.code)}
                                                        >
                                                            Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Research Links Editor Modal */}
                    {editingLinks && (
                        <div className="modal-overlay" onClick={() => setEditingLinks(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Edit Research Links</h2>
                                    <button className="close-btn" onClick={() => setEditingLinks(null)}>Ã—</button>
                                </div>

                                <div style={{maxHeight: '60vh', overflowY: 'auto', padding: '1.5rem'}}>
                                    {linksData.map((link, index) => (
                                        <div key={index} style={{
                                            background: 'var(--bg-light)', 
                                            padding: '1.5rem', 
                                            borderRadius: '8px', 
                                            marginBottom: '1rem',
                                            border: '1px solid var(--border-light)'
                                        }}>
                                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                                                <strong>Link {index + 1}</strong>
                                                <button 
                                                    className="btn btn-danger" 
                                                    style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                    onClick={() => deleteLink(index)}
                                                >
                                                    Remove
                                                </button>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Name</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={link.name}
                                                    onChange={(e) => updateLink(index, 'name', e.target.value)}
                                                    placeholder="e.g., Yahoo Finance"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">URL</label>
                                                <input
                                                    type="url"
                                                    className="form-input"
                                                    value={link.url}
                                                    onChange={(e) => updateLink(index, 'url', e.target.value)}
                                                    placeholder="https://..."
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Description</label>
                                                <input
                                                    type="text"
                                                    className="form-input"
                                                    value={link.description}
                                                    onChange={(e) => updateLink(index, 'description', e.target.value)}
                                                    placeholder="Brief description of the resource"
                                                />
                                            </div>
                                        </div>
                                    ))}

                                    <button 
                                        className="btn btn-secondary" 
                                        style={{width: '100%', marginTop: '1rem'}}
                                        onClick={addLink}
                                    >
                                        + Add New Link
                                    </button>
                                </div>

                                <div style={{padding: '1.5rem', borderTop: '1px solid var(--border-light)'}}>
                                    <button 
                                        className="btn btn-primary" 
                                        style={{width: '100%'}}
                                        onClick={() => saveLinks(editingLinks)}
                                    >
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Interest Rate Editor Modal */}
                    {editingInterest && (
                        <div className="modal-overlay" onClick={() => setEditingInterest(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                                <div className="modal-header">
                                    <h2 className="modal-title">Edit Interest & Dividend Settings</h2>
                                    <button className="close-btn" onClick={() => setEditingInterest(null)}>Ã—</button>
                                </div>

                                <div className="modal-body">
                                    <div className="alert-info" style={{marginBottom: '1.5rem'}}>
                                        <strong>Class-Wide Settings</strong>
                                        <p style={{marginTop: '0.5rem', fontSize: '0.9rem'}}>
                                            These settings apply to all students in this class by default. You can override them for individual students in Student Management.
                                        </p>
                                    </div>

                                    <h3 style={{marginBottom: '1rem', marginTop: '1.5rem'}}>Interest Settings</h3>
                                    <div className="form-group">
                                        <label className="form-label">Interest Rate (%)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={interestRate}
                                            onChange={(e) => setInterestRate(e.target.value)}
                                            placeholder="e.g., 5 for 5%"
                                            step="0.1"
                                            min="0"
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Frequency (Days)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={interestFrequency}
                                            onChange={(e) => setInterestFrequency(e.target.value)}
                                            placeholder="e.g., 30 for monthly"
                                            min="1"
                                        />
                                    </div>

                                    <h3 style={{marginBottom: '1rem', marginTop: '2rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border-light)'}}>Dividend Settings</h3>
                                    <p style={{fontSize: '0.9rem', color: 'var(--text-gray)', marginBottom: '1rem'}}>
                                        Dividends work like an allowance - students receive a fixed amount regularly.
                                    </p>

                                    <div className="form-group">
                                        <label className="form-label">Dividend Amount ($)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={dividendAmount}
                                            onChange={(e) => setDividendAmount(e.target.value)}
                                            placeholder="e.g., 100"
                                            step="0.01"
                                            min="0"
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Frequency</label>
                                        <select
                                            className="form-input"
                                            value={dividendFrequency}
                                            onChange={(e) => setDividendFrequency(e.target.value)}
                                        >
                                            <option value="daily">Daily</option>
                                            <option value="bi-daily">Every 2 Days</option>
                                            <option value="tri-daily">Every 3 Days</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="bi-weekly">Bi-Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>

                                    <div style={{background: 'var(--bg-light)', padding: '1rem', borderRadius: '4px', marginTop: '1rem'}}>
                                        <strong>Summary:</strong>
                                        <p style={{marginTop: '0.5rem', color: 'var(--text-gray)', fontSize: '0.9rem'}}>
                                            Students will earn {interestRate || 0}% interest on cash every {interestFrequency || 30} days, 
                                            and receive ${dividendAmount || 0} {dividendFrequency || 'weekly'}.
                                        </p>
                                    </div>

                                    <button 
                                        className="btn btn-primary"
                                        style={{width: '100%', marginTop: '1.5rem'}}
                                        onClick={() => saveInterest(editingInterest)}
                                    >
                                        Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ============ STUDENT MANAGEMENT VIEW ============
        const StudentManagementView = ({ teacherCodes, students, data, setData }) => {
            const [selectedClass, setSelectedClass] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [editingStudent, setEditingStudent] = useState(null);
            const [studentSettings, setStudentSettings] = useState({});

            const getClassStudents = (classCode) => {
                return students.filter(s => s.teacherCode === classCode);
            };

            const selectStudent = (student) => {
                setSelectedStudent(student);
                const classCode = teacherCodes.find(c => c.code === student.teacherCode);
                setStudentSettings({
                    interestRate: student.interestRateOverride !== undefined ? student.interestRateOverride : classCode?.interestRate || 0,
                    interestFrequency: student.interestFrequencyOverride !== undefined ? student.interestFrequencyOverride : classCode?.interestFrequency || 30,
                    dividendAmount: student.dividendAmountOverride !== undefined ? student.dividendAmountOverride : classCode?.dividendAmount || 0,
                    dividendFrequency: student.dividendFrequencyOverride !== undefined ? student.dividendFrequencyOverride : classCode?.dividendFrequency || 'weekly',
                });
            };

            const saveStudentSettings = () => {
                const updatedUsers = data.users.map(u => 
                    u.id === selectedStudent.id ? {
                        ...u,
                        interestRateOverride: studentSettings.interestRate,
                        interestFrequencyOverride: studentSettings.interestFrequency,
                        dividendAmountOverride: studentSettings.dividendAmount,
                        dividendFrequencyOverride: studentSettings.dividendFrequency
                    } : u
                );
                setData({ ...data, users: updatedUsers });
                setEditingStudent(null);
                alert('Student settings updated!');
            };

            const pauseStudent = (studentId) => {
                if (confirm('Pause this student account? They will not be able to log in.')) {
                    const updatedUsers = data.users.map(u => 
                        u.id === studentId ? { ...u, isPaused: true } : u
                    );
                    setData({ ...data, users: updatedUsers });
                }
            };

            const unpauseStudent = (studentId) => {
                const updatedUsers = data.users.map(u => 
                    u.id === studentId ? { ...u, isPaused: false } : u
                );
                setData({ ...data, users: updatedUsers });
            };

            const deleteStudent = (studentId) => {
                if (confirm('PERMANENTLY DELETE this student and all their data? This cannot be undone!')) {
                    const updatedUsers = data.users.filter(u => u.id !== studentId);
                    setData({ ...data, users: updatedUsers });
                    setSelectedStudent(null);
                }
            };

            if (selectedStudent) {
                const portfolioValue = selectedStudent.balance + selectedStudent.portfolio.reduce((sum, h) => 
                    sum + (h.shares * h.avgCost), 0
                );
                const totalGain = portfolioValue - 100000;
                const totalGainPercent = (totalGain / 100000) * 100;

                return (
                    <div>
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => setSelectedStudent(null)}
                            style={{marginBottom: '1.5rem'}}
                        >
                            â† Back to Class
                        </button>

                        <div style={{background: 'var(--bg-white)', padding: '2rem', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0,0,0,0.1)', marginBottom: '2rem'}}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'start'}}>
                                <div>
                                    <h2 style={{fontSize: '2rem', marginBottom: '0.5rem'}}>{selectedStudent.name}</h2>
                                    <p style={{color: 'var(--text-gray)'}}>@{selectedStudent.username}</p>
                                    {selectedStudent.isPaused && (
                                        <div style={{background: '#ffd700', color: '#000', padding: '0.5rem 1rem', borderRadius: '4px', display: 'inline-block', marginTop: '0.5rem', fontWeight: '600'}}>
                                            â¸ ACCOUNT PAUSED
                                        </div>
                                    )}
                                </div>
                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                    <button 
                                        className="btn btn-primary" 
                                        onClick={() => setEditingStudent(selectedStudent.id)}
                                    >
                                        Edit Settings
                                    </button>
                                    {selectedStudent.isPaused ? (
                                        <button 
                                            className="btn btn-secondary" 
                                            onClick={() => unpauseStudent(selectedStudent.id)}
                                        >
                                            Unpause
                                        </button>
                                    ) : (
                                        <button 
                                            className="btn btn-secondary" 
                                            onClick={() => pauseStudent(selectedStudent.id)}
                                        >
                                            Pause Account
                                        </button>
                                    )}
                                    <button 
                                        className="btn btn-danger" 
                                        onClick={() => deleteStudent(selectedStudent.id)}
                                    >
                                        Delete Student
                                    </button>
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginTop: '2rem'}}>
                                <div>
                                    <div style={{fontSize: '0.85rem', color: 'var(--text-gray)', marginBottom: '0.5rem'}}>Portfolio Value</div>
                                    <div style={{fontSize: '1.5rem', fontWeight: '700'}}>${portfolioValue.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.85rem', color: 'var(--text-gray)', marginBottom: '0.5rem'}}>Cash Balance</div>
                                    <div style={{fontSize: '1.5rem', fontWeight: '700', color: 'var(--primary-green)'}}>${selectedStudent.balance.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.85rem', color: 'var(--text-gray)', marginBottom: '0.5rem'}}>Total Gain/Loss</div>
                                    <div style={{fontSize: '1.5rem', fontWeight: '700', color: totalGain >= 0 ? 'var(--success-green)' : 'var(--loss-red)'}}>
                                        {totalGain >= 0 ? '+' : ''}${totalGain.toFixed(2)} ({totalGainPercent.toFixed(2)}%)
                                    </div>
                                </div>
                                <div>
                                    <div style={{fontSize: '0.85rem', color: 'var(--text-gray)', marginBottom: '0.5rem'}}>Holdings</div>
                                    <div style={{fontSize: '1.5rem', fontWeight: '700'}}>{selectedStudent.portfolio.length}</div>
                                </div>
                            </div>
                        </div>

                        {/* Student Portfolio */}
                        <div className="table-container" style={{marginBottom: '2rem'}}>
                            <div className="table-header">
                                <div className="table-title">Portfolio Holdings</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Shares</th>
                                        <th>Avg Cost</th>
                                        <th>Total Cost</th>
                                        <th>Current Value</th>
                                        <th>Gain/Loss</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {selectedStudent.portfolio.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" style={{textAlign: 'center', padding: '2rem', color: 'var(--text-gray)'}}>
                                                No holdings yet
                                            </td>
                                        </tr>
                                    ) : (
                                        selectedStudent.portfolio.map((holding) => {
                                            const totalCost = holding.avgCost * holding.shares;
                                            const currentValue = holding.avgCost * holding.shares; // Using avgCost as proxy
                                            const gainLoss = currentValue - totalCost;

                                            return (
                                                <tr key={holding.symbol}>
                                                    <td className="symbol-cell">{holding.symbol}</td>
                                                    <td>{holding.shares}</td>
                                                    <td className="price-cell">${holding.avgCost.toFixed(2)}</td>
                                                    <td className="price-cell">${totalCost.toFixed(2)}</td>
                                                    <td className="price-cell">${currentValue.toFixed(2)}</td>
                                                    <td className={gainLoss >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                        {gainLoss >= 0 ? '+' : ''}${gainLoss.toFixed(2)}
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Student Transactions */}
                        <div className="table-container">
                            <div className="table-header">
                                <div className="table-title">Transaction History</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Symbol</th>
                                        <th>Shares</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {selectedStudent.transactions.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" style={{textAlign: 'center', padding: '2rem', color: 'var(--text-gray)'}}>
                                                No transactions yet
                                            </td>
                                        </tr>
                                    ) : (
                                        selectedStudent.transactions.slice(0, 20).map((t) => (
                                            <tr key={t.id}>
                                                <td>{new Date(t.date).toLocaleDateString()}</td>
                                                <td>{t.type.toUpperCase()}</td>
                                                <td className="symbol-cell">{t.symbol}</td>
                                                <td>{t.shares}</td>
                                                <td className="price-cell">${t.price.toFixed(2)}</td>
                                                <td className={t.type === 'buy' ? 'gain-negative' : 'gain-positive'}>
                                                    {t.type === 'buy' ? '-' : '+'}${t.total.toFixed(2)}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* Edit Student Settings Modal */}
                        {editingStudent && (
                            <div className="modal-overlay" onClick={() => setEditingStudent(null)}>
                                <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                                    <div className="modal-header">
                                        <h2 className="modal-title">Edit Student Settings</h2>
                                        <button className="close-btn" onClick={() => setEditingStudent(null)}>Ã—</button>
                                    </div>
                                    <div className="modal-body">
                                        <div className="alert-info" style={{marginBottom: '1.5rem'}}>
                                            These settings override the class defaults for this student only.
                                        </div>

                                        <h3 style={{marginBottom: '1rem'}}>Interest Settings</h3>
                                        <div className="form-group">
                                            <label className="form-label">Interest Rate (%)</label>
                                            <input
                                                type="number"
                                                className="form-input"
                                                value={studentSettings.interestRate}
                                                onChange={(e) => setStudentSettings({...studentSettings, interestRate: parseFloat(e.target.value) || 0})}
                                                step="0.1"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Frequency (Days)</label>
                                            <input
                                                type="number"
                                                className="form-input"
                                                value={studentSettings.interestFrequency}
                                                onChange={(e) => setStudentSettings({...studentSettings, interestFrequency: parseInt(e.target.value) || 30})}
                                            />
                                        </div>

                                        <h3 style={{marginBottom: '1rem', marginTop: '2rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border-light)'}}>Dividend Settings</h3>
                                        <div className="form-group">
                                            <label className="form-label">Dividend Amount ($)</label>
                                            <input
                                                type="number"
                                                className="form-input"
                                                value={studentSettings.dividendAmount}
                                                onChange={(e) => setStudentSettings({...studentSettings, dividendAmount: parseFloat(e.target.value) || 0})}
                                                step="0.01"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Frequency</label>
                                            <select
                                                className="form-input"
                                                value={studentSettings.dividendFrequency}
                                                onChange={(e) => setStudentSettings({...studentSettings, dividendFrequency: e.target.value})}
                                            >
                                                <option value="daily">Daily</option>
                                                <option value="bi-daily">Every 2 Days</option>
                                                <option value="tri-daily">Every 3 Days</option>
                                                <option value="weekly">Weekly</option>
                                                <option value="bi-weekly">Bi-Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>

                                        <button 
                                            className="btn btn-primary"
                                            style={{width: '100%', marginTop: '1.5rem'}}
                                            onClick={saveStudentSettings}
                                        >
                                            Save Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (selectedClass) {
                const classStudents = getClassStudents(selectedClass);
                
                return (
                    <div>
                        <button 
                            className="btn btn-secondary" 
                            onClick={() => setSelectedClass(null)}
                            style={{marginBottom: '1.5rem'}}
                        >
                            â† Back to All Classes
                        </button>

                        <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>
                            {teacherCodes.find(c => c.code === selectedClass)?.className} Students
                        </h2>

                        <div className="table-container">
                            <div className="table-header">
                                <div className="table-title">Students ({classStudents.length})</div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Portfolio Value</th>
                                        <th>Cash</th>
                                        <th>Gain/Loss</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {classStudents.map((student) => {
                                        const portfolioValue = student.balance + student.portfolio.reduce((sum, h) => 
                                            sum + (h.shares * h.avgCost), 0
                                        );
                                        const totalGain = portfolioValue - 100000;

                                        return (
                                            <tr key={student.id}>
                                                <td>{student.name}</td>
                                                <td>@{student.username}</td>
                                                <td className="price-cell">${portfolioValue.toFixed(2)}</td>
                                                <td className="price-cell">${student.balance.toFixed(2)}</td>
                                                <td className={totalGain >= 0 ? 'gain-positive' : 'gain-negative'}>
                                                    {totalGain >= 0 ? '+' : ''}${totalGain.toFixed(2)}
                                                </td>
                                                <td>
                                                    {student.isPaused ? (
                                                        <span style={{color: '#ffd700', fontWeight: '600'}}>â¸ Paused</span>
                                                    ) : (
                                                        <span style={{color: 'var(--success-green)', fontWeight: '600'}}>âœ“ Active</span>
                                                    )}
                                                </td>
                                                <td>
                                                    <button 
                                                        className="btn btn-primary"
                                                        style={{padding: '0.4rem 0.8rem', fontSize: '0.85rem'}}
                                                        onClick={() => selectStudent(student)}
                                                    >
                                                        View Details
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            // Default view - show all classes
            return (
                <div>
                    <h2 style={{fontSize: '2rem', marginBottom: '2rem'}}>Student Management by Class</h2>
                    
                    <div style={{display: 'grid', gap: '1.5rem'}}>
                        {teacherCodes.map((code) => {
                            const classStudents = getClassStudents(code.code);
                            
                            return (
                                <div 
                                    key={code.code}
                                    style={{
                                        background: 'var(--bg-white)',
                                        padding: '2rem',
                                        borderRadius: '8px',
                                        boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    }}
                                    onClick={() => setSelectedClass(code.code)}
                                    onMouseEnter={(e) => {
                                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                                        e.currentTarget.style.transform = 'translateY(-2px)';
                                    }}
                                    onMouseLeave={(e) => {
                                        e.currentTarget.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                        e.currentTarget.style.transform = 'translateY(0)';
                                    }}
                                >
                                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                        <div>
                                            <h3 style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>{code.className}</h3>
                                            <p style={{color: 'var(--text-gray)'}}>Code: <span className="class-code">{code.code}</span></p>
                                        </div>
                                        <div style={{textAlign: 'right'}}>
                                            <div style={{fontSize: '2rem', fontWeight: '700', color: 'var(--primary-blue)'}}>
                                                {classStudents.length}
                                            </div>
                                            <div style={{fontSize: '0.9rem', color: 'var(--text-gray)'}}>Students</div>
                                        </div>
                                    </div>
                                    <div style={{marginTop: '1.5rem', paddingTop: '1.5rem', borderTop: '1px solid var(--border-light)', display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem'}}>
                                        <div>
                                            <div style={{fontSize: '0.85rem', color: 'var(--text-gray)'}}>Interest</div>
                                            <div style={{fontSize: '0.95rem', fontWeight: '600'}}>{code.interestRate || 0}% / {code.interestFrequency || 30} days</div>
                                        </div>
                                        <div>
                                            <div style={{fontSize: '0.85rem', color: 'var(--text-gray)'}}>Dividend</div>
                                            <div style={{fontSize: '0.95rem', fontWeight: '600'}}>${code.dividendAmount || 0} {code.dividendFrequency || 'weekly'}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // ============ RENDER APP ============
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
